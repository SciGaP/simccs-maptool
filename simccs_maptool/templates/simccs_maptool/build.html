
{% extends "base.html" %}
{% load static %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

{% block css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/leaflet.css' %}" />
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

<style type="text/css">
      #map{
      /*margin-left: 20px;*/
      /*margin-top: 60px;*/
      /*margin-top: 60px;*/
      width:100%;
      height:100% ;
      }
      .main-content {
            max-width: initial;
      }
      .container-fluid, .main-row {
            height: 100%;
      }
      .card {
            margin-bottom: 0px;
      }
      /* Allow vertical scrolling of sidebar if not enough room on screen */
      .main-row > .col-md-3 {
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
      }
      .legend {
            line-height: 18px;
            color: #555;
      }
      .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
      }

</style>
{% endblock css %}

{% block scripts %}
<script src="{% static 'js/leaflet.js' %}"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<link rel="stylesheet" type="text/css" href="{% static 'css/leaflet-sidebar.min.css' %}" />
<script src="{% static 'js/leaflet-sidebar.min.js' %}"></script>
<script src="{% static 'js/build.js' %}" ></script>
<script src="{% static 'js/util.js' %}" ></script>
<script src="{% static 'django_airavata_api/dist/airavata-api.js' %}"></script>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
<!-- Latest compiled and minified JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
<script src="https://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>


<script>
         //var Maptool = window.Maptool || {};
         //Maptool.FeatureFlag = Maptool.FeatureFlag || {};
         // TODO: replace with global user session object
         var userIsAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};
         
         $(document).ready(function() {
            // set up data
            set_casedata();
            sidebar.open("home");

            //bind slector event
            $(document).on("changed.bs.select",".selectpicker",function() {
            //$('.selectpicker').on('changed.bs.select', function (e,clickedIndex, newValue, oldValue) {
                  var dataid = (this.id).split("_")[1];
                  var selected_ids = $(this).val();
                  source_selectbynames(dataid,selected_ids);
            });
 
            }); // end of document ready 

var casejson;
var maplayers = {}; // record layers displayed on map, layername:layerdata
var sourceselection = []; // current source selection
var sinkselection = []; // current sink selection
var sourceselection_panel = {}; // panelid:data
var sinkselection_panel = {}; // panelid:data

async function set_casedata() {
      var urlprefix = "/static/Data/Build/";
      casejson = await getdata(urlprefix + '123test.json');
      document.getElementById("case_name").textContent=casejson["Title"];
      document.getElementById("case_description").textContent=casejson["Description"]; 
      // move map to bounding box
      var bbox = casejson["Maptool"]["BBOX"];
      map.fitBounds([[bbox[1],bbox[0]],[bbox[3],bbox[2]]]);
      // reformat data as big array
      var datasets = {};
      for (entry of casejson['Datasets'])
      {
            datasets[entry['DataID']]={'dataid':entry['DataID'],'name': entry['Name'], 'description':entry['Description'],'type':entry['Type']};
      }
      
      //load source/sink
      var dataurl, datastyle, datameta;
      for (entry of casejson['Maptool']['Data']) {
            datameta = datasets[entry["DataID"]];
            dataurl = urlprefix + entry["URL"];
            datastyle = entry['Style'];
            popupfields = entry['Popup'];
            addcasedata(datameta,dataurl,datastyle,popupfields);
      }
      // load cost surface
      addcostsurface(bbox);
}

// create a new scenario
var scenarioid = 1;

// generate source data from sourceslection
function generatesourcedata(selections) {
      var sourcedata = "ID\tcostFix ($M)\tfixO&M ($M/y)\tvarO&M ($/tCO2)\tcapMax (MtCO2/y)\tN/A\tLON\tLAT\tNAME\n";
      var cols =["ID","costFix","fixOM","varOM","capMax","N/A","X","Y","Name"];
      var col_dict = {"ID":"UniqueID","costFix":"TotalUnitCost","fixOM":"FixedOM","varOM":"VarOM","capMax":"CapCO2","N/A":"","X":"X","Y":"Y","Name":"Name"};
      var tempstr = "";
      for (i = 0; i < selections.length; i++) {
            tempstr = "";
            //tempstr += (i+1).toString()+"\t";
            for ( key of cols) {
                  if (key == "N/A") {
                  tempstr += "1"+"\t";
                  } else {
                        if (selections[i].feature.properties[col_dict[key]] == "-") {tempstr += " \t";}
                        else {tempstr += selections[i].feature.properties[col_dict[key]]+"\t";} 
                  } 
            }
            sourcedata += tempstr + "\n";
      } 
      return sourcedata;
}

// generate sink data from sinkselection
function generatesinkdata (selections) {
      var header_array = ["ID", "Sink_ID", "fieldCap (MtCO2)", "costFix ($M)", "fixO&M ($M/yr)", "wellCap (MtCO2/yr)", "wellCostFix ($M)", "wellFixO&M ($M/yr)", "varO&M ($/tCO2)", "N/A", "LON", "LAT", "N/A", "N/A", "N/A", "N/A", "Name"];
      var sinkdata=header_array.join('\t') + "\n";
      var cols =["ID","Sink_ID", "fieldCap", "costFix", "fixOM", "wellCap", "wellCostFix", "wellFixOM", "varOM", "N/A", "LON", "LAT", "N/A", "N/A", "N/A", "N/A", "Name"];
      var col_dict = {"ID":0,"Sink_ID":"UniqueID","fieldCap":"StorageCap", "costFix":"TotalUnitCost","fixOM":"SiteOM","wellCap":"InjCap","wellCostFix":"WellRate","wellFixOM":"InjectionOM","varOM":"InjVarOM","N/A":"","LON":"X","LAT":"Y","Name":"Name"};
      var tempstr = "";
      for (i = 0; i < selections.length; i++) {
            tempstr = "";
            for ( key of cols) {
                  if (key == "N/A") {
                        tempstr += "0"+"\t";
                  } else if (key == "ID") {
                        tempstr += (i+1).toString() + "\t";
                  } else {
                        if (selections[i].feature.properties[col_dict[key]] == "-") {tempstr += " \t";}
                        else {tempstr += selections[i].feature.properties[col_dict[key]]+"\t";}
                  } 
            }
            sinkdata += tempstr + "\n";
      } 
      return sinkdata;

}

function createdownloadlink(filename, data, text) {
    var element = document.createElement('a');
    //element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    var file = new Blob([data], {type: 'text/plain'});
    element.href = URL.createObjectURL(file);
    element.setAttribute('download', filename);
    element.text = text;
    element.style.display = 'block';
    return element;
}

function arrayToTable(textblob) {
    var tableData = textblob.split("\n");
    var table = $('<table class="table table-sm table-condensed table-bordered"></table>');
    $(tableData).each(function (i, rowData) {
        var row = $('<tr></tr>');
        var rowData_a = rowData.split("\t");
        if (rowData_a.length > 1) {
        $(rowData_a).each(function (j, cellData) {
            row.append($('<td>'+cellData+'</td>'));
        });
        table.append(row); }
    });
    return table[0].outerHTML;
}

function toggle_table_visibility(tableid) {
      var e = document.getElementById(tableid);
       if(e.style.display == 'block')
          e.style.display = 'none';
       else
          e.style.display = 'block';
    }

function displayselecteddata(panelid) {
      // record data first
      sourceselection_panel[panelid] = sourceselection;
      sinkselection_panel[panelid] = sinkselection;

      var div = document.createElement("div");
      var sourcetxt = generatesourcedata(sourceselection);
      div.innerHTML +="<Strong>Sources selected: " + sourceselection.length + "</Strong>";
      var downloadlink = createdownloadlink("source.txt",sourcetxt,"Download Sources.txt");
      div.appendChild(downloadlink);
      //div.innerHTML += "<br>";
      //div.innerHTML += "<p>" + sourcetxt + "</p>";
      var table_id = "source_table_" + panelid;
      div.innerHTML+='<a href="#" onclick=toggle_table_visibility("' + table_id + '")>Show/hide source data</a>';
      div.innerHTML += "<br>";
      div.innerHTML += '<div id='+ table_id +' style="overflow: auto;height: 200px; width: 95%; display: none" >'+arrayToTable(sourcetxt)+"</div>";
      var sinktxt = generatesinkdata(sinkselection);
      div.innerHTML += "<br>";
      div.innerHTML +="<Strong>Sink selected: " + sinkselection.length + "</Strong>";
      downloadlink = createdownloadlink("sink.txt",sinktxt,"Download Sinks.txt");
      div.appendChild(downloadlink);
      //div.innerHTML += "<p>" + sinktxt + "</p>";
      table_id = "sink_table_" + panelid;
      div.innerHTML+='<a href="#" onclick=toggle_table_visibility("' + table_id + '")>Show/hide sink data</a>';
      div.innerHTML += "<br>";
      div.innerHTML += '<div id='+ table_id +' style="overflow: auto;height: 200px; width: 95%; display: none">'+arrayToTable(sinktxt)+"</div>";
      div.innerHTML += "<br>";
      

      // grab model parameters
      mp_list = ["Capital_Recovery_Rate","Project_Period","Capture_Target"]; 
      var p_value;
      var mp_div = document.getElementById('model_parameters').outerHTML;
      mp_div = mp_div.replace("125%","100%");
      var tb_new = "";
      var tb_entry;
      for (const entry of mp_list) {
            //get the value
            p_value = $('#'+entry).val();
            tb_entry = '<tr><td>Capital Recovery Rate</td><td><input id="Capital_Recovery_Rate" name="Capital_Recovery_Rate" type="text" size=8 value='+  p_value +' required></td></tr>';
            tb_entry = tb_entry.replace(new RegExp(entry, 'g'), entry +"_"+ panelid);
            tb_new += tb_entry;
      }
      mp_div= mp_div.replace(/<table>[\s\S]*?<\/table>/, '<table>' + tb_new + '<\/table>');
      div.innerHTML += mp_div;
      div.innerHTML += "<br>";
      div.innerHTML += '<button type="button" class="btn btn-primary btn-sm btn-block" onclick="create_experment()"><strong>Create a New Experiment</strong></button>';
      div.innerHTML += '<button type="button" id="bn_generatecandidatenetwork" class="btn btn-primary btn-sm btn-block" onclick=generatecandidatenetwork("'+ panelid +'")>Generate Candidate Network</button>';

      return div;
}


function create_scenario() {
      if (scenarioid > 5 ) {alert("Maximum number of scenarios reached!");return;};
      
      // check if the source/sink are selected
      if (sourceselection.length == 0 ) {alert('No sources are selected!');return}
      if (sinkselection.length == 0 ) {alert('No sinks are selected!');return}
      var panelid = 'scenario' + scenarioid;
      var panediv = displayselecteddata(panelid);
      var title = 'Scenario ' + scenarioid;
      // get the name of scenario
      var sname = prompt("Please name the secenario", title);
      if (sname != null) { title = sname;} else {return;}
      sidebar.addPanel({
            id:   panelid,
            tab:  '<i class="fa fa-cog" aria-hidden="true"></i>',
            title: title,
            pane: '<div style="font-size: 125%">' + panediv.innerHTML +"</div>",
      });
      scenarioid += 1;
      // simple show the data
      sidebar.open(panelid);
      
}
  
     
</script>
{% endblock scripts %}

{% block content %}

<div id="sidebar" class="leaflet-sidebar collapsed">

      <!-- nav tabs -->
        <div class="leaflet-sidebar-tabs">
            <!-- top aligned tabs -->
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fas fa-tools"></i></a></li>
            </ul>

            <!-- bottom aligned tabs -->
            <ul role="tablist">
                  <li><a href="#profile" role="tab"><i class="fa fa-user"></i></a></li>
                <li><a href="#settings" role="tab"><i class="fas fa-toolbox"></i></a></li>
            </ul>
        </div>

        <!-- panel content -->
        <div class="leaflet-sidebar-content">
            <div class="leaflet-sidebar-pane" id="home">
                <h1 class="leaflet-sidebar-header">
                    Build: <span id="case_name"></span>
                    <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                <div><span  style="font-size: 150%" id="case_description"></span></div>
                <div id="layercontrol" class="form-check" style="font-size: 150%"></div>
                <br>
                <!-- model parameters-->
                <div class="card border-info">
                <div class="card-body">
                <div id="model_parameters" style="font-size: 125%">
                <strong>Model Parameters</strong><br>
                <table>
                            <tr><td>Capital Recovery Rate</td><td><input id="Capital_Recovery_Rate" name="Capital_Recovery_Rate" type="text" size=8 value="0.1" required></td></tr>
                            <tr><td>Project Period (yrs)</td><td><input id="Project_Period" name="Project_Period" type="text" size=8 value="10" required></td></tr>
                            <tr><td>Capture Target (MT/y)</td><td><input id="Capture_Target" name="Capture_Target" type="text" size=8 value="5" required></td></tr>
                </table>
                </div>
                </div>
            </div>
                <!-- end of model parameters-->

                <button type="button" class="btn btn-primary btn-sm btn-block" onclick="create_scenario()"><strong>Create Scenario with the Selected</strong></button>  
                <button type="button" class="btn btn-primary btn-sm btn-block" onclick="clear_selection()"><strong>Clear the Selections</strong></button>  
            </div>

            <div class="leaflet-sidebar-pane" id="profile">
                  <h1 class="leaflet-sidebar-header">Profile<div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div></h1>
            </div>
 
            <div class="leaflet-sidebar-pane" id="settings">
                <h1 class="leaflet-sidebar-header">Settings<span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <br>
                <button type="button" class="btn btn-primary btn-sm btn-block" onclick="save_workspace()"><strong>Save Current Workspace</strong></button>  

            </div>
        </div>
    </div>

  <div class="main-content-wrapper">
    <main class="main-content">
      <div class="container-fluid">
                  <div id="map"></div>
      </div>

    </main>
  </div>


{% endblock content %}
