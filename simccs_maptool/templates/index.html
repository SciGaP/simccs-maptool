{% extends "base.html" %}
{% load static %}

{% block css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/MarkerCluster.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/MarkerCluster_Default.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/leaflet.css' %}" />
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.css" />
<style type="text/css">
      #map{
      /*margin-left: 20px;*/
      /*margin-top: 60px;*/
      /*margin-top: 60px;*/
      width:99%;
      height:100% ;
      }
      .main-content {
            max-width: initial;
      }
      .container-fluid, .main-row {
            height: 100%;
      }
      .card {
            margin-bottom: 0px;
      }
</style>
{% endblock css %}

{% block scripts %}
<script src="{% static 'js/leaflet.js' %}"></script>
<script src="{% static 'js/leaflet.markercluster-src.js' %}"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.js"></script>
<script src="{% static 'js/leafletMap.js' %}" ></script>
<script src="{% static 'django_airavata_api/dist/airavata-api.js' %}"></script>
      <script>
         // TODO: replace with global user session object
         var userIsAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};
         //var userIsAuthenticated = true;
         $(document).ready(function() {
      
           load_current_experiment();
           map.addLayer(ordos_source_cluster);
           map.addLayer(france_source_cluster);
         
         
         $('input:radio').bind('click mousedown', (function() {
             var isChecked;
             return function(event) {
                 if (event.type == 'click') {
                     radio_button_id=this.id;
                     if (isChecked) {
                         isChecked = this.checked = false;
                         switch(radio_button_id){
                             case "cost_surface":map.removeLayer(cost_surface_layer);
                                                 break;
                             case "source_sink_chemical":map.removeLayer(chemicalClusters)
                                   break;
                             case "source_sink_coal":map.removeLayer(coalClusters)
                                   break;
                             case "source_sink_flourinated":map.removeLayer(flourinatedClusters)
                                   break;
                             case "source_sink_industrial_gas":map.removeLayer(industrialGasClusters)
                                   break;
                             case "source_sink_co2_injecton":map.removeLayer(co2InjectionClusters)
                                   break;
                             case "source_sink_metals":map.removeLayer(metalClusters)
                                   break;
                             case "source_sink_minerals":map.removeLayer(mineralClusters)
                                   break;
                             case "source_sink_natural_gas":map.removeLayer(naturalGasClusters)
                                   break;
                             case "source_sink_others":map.removeLayer(otherClusters)
                                   break;
                             case "source_sink_petroleum":map.removeLayer(petroleumClusters)
                                   break;
                             case "source_sink_petro_natural":map.removeLayer(petroleumNaturalGasClusters)
                                   break;
                             case "source_sink_power_plants":map.removeLayer(powerPlantClusters)
                                   break;
                             case "source_sink_pulp_paper":map.removeLayer(pulpClusters)
                                   break;
                             case "source_sink_refineries":map.removeLayer(refineriesClusters)
                                   break;
                             case "source_sink_co2_suppliers":map.removeLayer(co2SupplyClusters)
                                   break;
                             case "source_sink_waste":map.removeLayer(wasteClusters)
                                   break;
                             case "source_sink_pulp_paper":map.removeLayer(chemicalClusters)
                                   break;
         
                             case "source_sink_all_the_above":
                             map.removeLayer(chemicalClusters);
                                 map.removeLayer(coalClusters);
                                 map.removeLayer(flourinatedClusters);
                                 map.removeLayer(co2InjectionClusters);
                                 map.removeLayer(metalClusters);
                                 map.removeLayer(mineralClusters);
                                 map.removeLayer(naturalGasClusters);
                                 map.removeLayer(otherClusters);
                                 map.removeLayer(petroleumClusters);
                                 map.removeLayer(petroleumNaturalGasClusters);
                                 map.removeLayer(powerPlantClusters);
                                 map.removeLayer(pulpClusters);
                                 map.removeLayer(refineriesClusters);
                                 map.removeLayer(co2SupplyClusters);
                                 map.removeLayer(wasteClusters);
         
         
                                   break;
         
                             case "candidate_network":
                                                     map.removeLayer(ut_candidate_network);
                                                     map.removeLayer(albert_candidate_network);
                                                     map.removeLayer(illinios_candidate_network);
                                                     // map.removeLayer(ne_cadidate_network);
                                                     map.removeLayer(ordos_candidate_network);
                                                     map.removeLayer(se_candidate_network);
         
                                                     // map.remove(ne_cadidate_network);
                             break;
         
                             //
                             case "sink_coal_reservoirs":map.removeLayer(sink_coal_layer);
                             break;
                             case "sink_saline_formation":map.removeLayer(sink_saline_layer);
                             break;
                             case "sink_oil_reservoir":map.removeLayer(sink_oil_layer);
                             break;
                             case "ordos_sink":map.removeLayer(sink_ordos_layer);
                             break;
                              case "france_sink":map.removeLayer(france_sink_cluster);
                             break;
         
                         }
         
                     } else {
                         isChecked = true;
                         switch(radio_button_id){
                             case "cost_surface":cost_surface_layer.addTo(map);
                                                 break;
                             case "source_sink_chemical":map.addLayer(chemicalClusters);
                                   break;
                             case "source_sink_coal":map.addLayer(coalClusters);
                                   break;
                             case "source_sink_flourinated":map.addLayer(flourinatedClusters);
                                   break;
                             case "source_sink_industrial_gas":map.addLayer(industrialGasClusters);
                                   break;
                             case "source_sink_co2_injecton":map.addLayer(co2InjectionClusters);
                                   break;
                             case "source_sink_metals":map.addLayer(metalClusters);
                                   break;
                             case "source_sink_minerals":map.addLayer(mineralClusters);
                                   break;
                             case "source_sink_natural_gas":map.addLayer(naturalGasClusters);
                                   break;
                             case "source_sink_others":map.addLayer(otherClusters);
                                   break;
                             case "source_sink_petroleum":map.addLayer(petroleumClusters);
                                   break;
                             case "source_sink_petro_natural":map.addLayer(petroleumNaturalGasClusters);
                                   break;
                             case "source_sink_power_plants":map.addLayer(powerPlantClusters);
                                   break;
                             case "source_sink_pulp_paper":map.addLayer(pulpClusters);
                                   break;
                             case "source_sink_refineries":map.addLayer(refineriesClusters);
                                   break;
                             case "source_sink_co2_suppliers":map.addLayer(co2SupplyClusters);
                                   break;
         
                             case "source_sink_waste":map.addLayer(wasteClusters);
                                   break;
         
         
         
                             case "source_sink_all_the_above":
                             map.addLayer(chemicalClusters);
                                 map.addLayer(coalClusters);
                                 map.addLayer(flourinatedClusters);
                                 map.addLayer(co2InjectionClusters);
                                 map.addLayer(metalClusters);
                                 map.addLayer(mineralClusters);
                                 map.addLayer(naturalGasClusters);
                                 map.addLayer(otherClusters);
                                 map.addLayer(petroleumClusters);
                                 map.addLayer(petroleumNaturalGasClusters);
                                 map.addLayer(powerPlantClusters);
                                 map.addLayer(pulpClusters);
                                 map.addLayer(refineriesClusters);
                                 map.addLayer(co2SupplyClusters);
                                 map.addLayer(wasteClusters);
                                 // map.addLayer(ordos_source_cluster);
                                 // map.addLayer(france_source_cluster);
         
         
                                   break;
         
         
                             case "candidate_network":
                             //
                             map.addLayer(albert_candidate_network);
                             map.addLayer(illinios_candidate_network);
                             map.addLayer(ne_cadidate_network);
                             map.addLayer(ordos_candidate_network);
                             //
                                 //se_candidate_network.addTo(map);
                                 //ut_candidate_network.addTo(map);
                                 //albert_candidate_network.addTo(map);
                                 //illinios_candidate_network.addTo(map);
                                 // // ne_cadidate_network.addTo(map);
                                 //ordos_candidate_network.addTo(map);
                                 // ne_cadidate_network.addTo(map);
                             break;
         
                             case "sink_coal_reservoirs":map.addLayer(sink_coal_layer);
                             break;
         
                             case "sink_saline_formation":map.addLayer(sink_saline_layer);
                             break;
                             case "sink_oil_reservoir":map.addLayer(sink_oil_layer);
                             break;
                             case "ordos_sink":map.addLayer(sink_ordos_layer);
                             break;
                             case "france_sink":map.addLayer(france_sink_cluster);
                             break;
                         }
                     }
                 } else {
                     isChecked = this.checked;
                 }
             }
         })());
         
         // continue document ready funtion
            $('#checkbox_southeastUS').change(function(){
			if(this.checked) {
				//$('#southeastUS_div').show();
                        // clear map, remove all layers
                        map.eachLayer(function (layer) {
                              //keep the basemap layer
                              if (layer != osm) {map.removeLayer(layer);};
                              });
                        // load sample layers
                        display_result_sample();
                  }
                  else {
                        //$('#southeastUS_div').hide();
                        map.eachLayer(function (layer) {
                              //keep the basemap layer
                              if (layer != osm) {layercontrol.removeLayer(layer);map.removeLayer(layer);};
                              });
                        
                  }
            });
        // continue document ready funtion
        $('#experiments_div').on('change', 'input', function() {
            if(this.checked) {
				//$('#southeastUS_div').show();
                        // clear map, remove all layers
                        map.eachLayer(function (layer) {
                              //keep the basemap layer
                              if (layer != osm) {map.removeLayer(layer);};
                              });
                        // load sample layers
                        display_experiment_result(this.value);
                  }
                  else {
                        //$('#southeastUS_div').hide();
                        map.eachLayer(function (layer) {
                              //keep the basemap layer
                              if (layer != osm) {layercontrol.removeLayer(layer);map.removeLayer(layer);};
                              });  
                  }
            });
 
         });
         
         var geojsonMarkerOptions = {
         radius: 8,
         fillColor: "blue",
         color: "#000",
         weight: 1,
         opacity: 1,
         fillOpacity: 0.7,
         pane: "pointsPane"
         };
         
         var selection=[];
         var sinkselection=[];
         var sinkselection2=[];
         function sourceOnEachFeature(feature, layer) {
         //bind click
         layer.on('click', function (e) {
           var target_id = selection.indexOf(e.target)
           if (target_id >=0 ) {e.target.setStyle(geojsonMarkerOptions);selection.splice(target_id,1);}
           else {e.target.setStyle({weight:2,color:"white",fillColor:"purple",radius:12});
                 selection.push(e.target);}
         })};
         
         function sinkOnEachFeature(feature, layer) {
         //bind click
         layer.bindTooltip("<strong>CO2_Low(t):"+feature.properties.CO2_Low__t.toString()+"<strong>");
         layer.on('click', function (e) {
           var target_id = sinkselection.indexOf(e.target)
           if (target_id >=0 ) {e.target.setStyle({weight:1,color:'grey',fillOpacity:0.4});sinkselection.splice(target_id,1);}
           else {e.target.setStyle({weight:2,color:"white",fillOpacity:0.7});
                 sinkselection.push(e.target);}
         })};
         
         function sinkOnEachFeature2(feature, layer) {
         //bind click
         layer.bindTooltip("<strong>CO2_Low(t):"+feature.properties.VOL_LOW.toString()+"<strong>");
         layer.on('click', function (e) {
           var target_id = sinkselection2.indexOf(e.target)
           if (target_id >=0 ) {e.target.setStyle({weight:1,color:'grey',fillOpacity:0.4});sinkselection2.splice(target_id,1);}
           else {e.target.setStyle({weight:2,color:"white",fillOpacity:0.7});
                 sinkselection2.push(e.target);}
         })};
         
         var sourceLayer = new L.geoJSON('', {
         pointToLayer: function (feature, latlng) {
           var content_str="<strong>"+feature.id+"<br>"+feature.properties.Facility_N +'<br>CO2 emission:'+feature.properties.CO2_Emissi+"</strong>";
           //var mypopup = L.popup().setContent(content_str);
           var mymarker = L.circleMarker(latlng, geojsonMarkerOptions);
           //mymarker.bindPopup(mypopup);
           mymarker.bindTooltip(content_str);
           return mymarker;       
         },
         //pane: "pointsPane",
         onEachFeature: sourceOnEachFeature
         });
         
         var sinkLayer = new L.geoJSON('',{style: function(feature){
           var co2 = feature.properties.CO2_Low__t;
           var fillcolor = ''; 
           if (co2 >= 1 && co2 < 5e+06) {fillcolor = '#f50000';} 
           else if (co2 >=5e+06 && co2 < 5e+07) {fillcolor ='#fdff00'}
           else {fillcolor = '#00f905'}
           return {'color':'grey','weight':1,'fillColor':fillcolor,'fillOpacity': 0.3,pane: "polygonsPane"};
         },
         
         onEachFeature: sinkOnEachFeature
         })
         
         var sinkLayer2 = new L.geoJSON('',{style: function(feature){
           var co2 = feature.properties.VOL_LOW;
           var fillcolor = ''; 
           if (co2 >= 1 && co2 < 5e+06) {fillcolor = '#f50000';} 
           else if (co2 >=5e+06 && co2 < 5e+07) {fillcolor ='#fdff00'}
           else {fillcolor = '#00f905'}
           return {'color':'grey','weight':1,'fillColor':fillcolor,'fillOpacity': 0.3,pane: "polygonsPane"};
         },
         
         onEachFeature: sinkOnEachFeature2
         })
           function loadjson(data) {
                 sourceLayer.addData(data);
                 sourceLayer.addTo(map);
                 layercontrol.addOverlay(sourceLayer,"Sources");
           }
         
           function loadsinklayer(data) {
                 sinkLayer.addData(data);
                 sinkLayer.addTo(map);
                 layercontrol.addOverlay(sinkLayer,"Sinks:Salines");
                 //sinkLayer.bringToBack();
           }
           
           function loadsinklayer2(data) {
                 sinkLayer2.addData(data);
                 sinkLayer2.addTo(map);
                 layercontrol.addOverlay(sinkLayer2,"Sinks:Oil/Gas");
                 //sinkLayer.bringToBack();
           }
           
           //get the list of selected source layers
           function get_selectedsourcelayers(){
                  // find all radio button id start with "source_"
                  var queryfields=[];
                  var source_dict = {};
                  source_dict['source_sink_chemical']='SimCCS:Source_Chemicals';
                  source_dict['source_sink_coal']='SimCCS:Source_Coal-based_Liquid_Fuel_Supply';	
                  source_dict['source_sink_flourinated']='SimCCS:Source_Import_and_Export_of_Equipment_Containing_Fluorintaed_GHGs';
                  source_dict['source_sink_industrial_gas']='SimCCS:Source_Industrial_Gas_Suppliers';	
                  source_dict['source_sink_co2_injecton']='SimCCS:Source_Injection_of_CO2';	
                  source_dict['source_sink_metals']='SimCCS:Source_Metals';	
                  source_dict['source_sink_minerals']='SimCCS:Source_Minerals';	
                  source_dict['source_sink_natural_gas']='SimCCS:Source_Natural_Gas_and_Natural_Gas_Liquids_Suppliers';
                  source_dict['source_sink_others']='SimCCS:Source_Other';	
                  source_dict['source_sink_petroleum']='SimCCS:Source_Petroleum_Product_Suppliers';
                  source_dict['source_sink_petro_natural']='SimCCS:Source_Petroleum_and_Natural_Gas_Systems';
                  source_dict['source_sink_power_plants']='SimCCS:Source_Power_Plants';
                  source_dict['source_sink_pulp_paper']='SimCCS:Source_Pulp_and_Paper';
                  source_dict['source_sink_refineries']='SimCCS:Source_Refineries';
                  source_dict['source_sink_co2_suppliers']='SimCCS:Source_Suppliers_of_CO2';
                  source_dict['source_sink_waste']='SimCCS:Source_Waste';
                  //"source_sink_all_the_above"
                  $("*[id^='source']:visible").each(function() {
                        if (this.checked) {queryfields.push(source_dict[this.id]);}
                  });
                  return queryfields.join();
           }

           function show_drawingtool(){
                  var querylayers = '';
                  querylayers = get_selectedsourcelayers();
                 if (querylayers == ''){alert("Please select at least one source!"); return;} 
                 // Initialise the FeatureGroup to store editable layers
                 var editableLayers = new L.FeatureGroup();
                 map.addLayer(editableLayers);
         
                 var drawPluginOptions = {
                 position: 'topright',
                 draw: {
                 polygon: {
                       allowIntersection: false, // Restricts shapes to simple polygons
                       drawError: {
                       color: '#e1e100', // Color the shape will turn when intersects
                       message: '<strong>Oh snap!<strong> you can\'t draw that!' // Message that will show when intersect
                       },
                       shapeOptions: {
                       color: '#97009c'
                       }
                 },
                 // disable toolbar item by setting it to false
                 polyline: false,
                 circle: true, // Turns off this drawing tool
                 rectangle: true,
                 marker: false,
                 },
                 edit: {
                 featureGroup: editableLayers, //REQUIRED!!
                 remove: false
                 }};
                 // Initialise the draw control and pass it the FeatureGroup of editable layers
                 var drawControl = new L.Control.Draw(drawPluginOptions);
                 map.addControl(drawControl);
                 //alert("Use drawing tool to setup a working area!");
         
         
                 var editableLayers = new L.FeatureGroup();
                 map.addLayer(editableLayers);
         
                 map.on('draw:created', function(e) {
                       // clear map, remove all layers
                       map.eachLayer(function (layer) {
                              //keep the basemap layer
                              if (layer != osm) {map.removeLayer(layer);};
                        });
                 var type = e.layerType,
                 layer = e.layer;
                 editableLayers.addLayer(layer);
                 var geom = layer.toGeoJSON()['geometry']['coordinates'];
                 if (type == 'circle') {layer.addTo(map);} 
                 var lbounds=layer.getBounds().pad(0.1);
                 //alert(lbounds.getCenter());
                 //alert(JSON.stringify(geom));
                 var coordstr=[];
                 for (i = 0, len = geom[0].length; i < len; i++) {
                 coordstr[i]= (geom[0][i].toString()).replace(',',' ');} 
                 //alert(coordstr.join(','));
                 var geourl='https://beta.simccs.org/geoserver/SimCCS/ows?service=WFS&version=1.0.0&request=GetFeature&maxFeatures=500&outputFormat=text%2Fjavascript&format_options=callback:loadjson';
                 geourl += '&typeName=' + querylayers;
                 var cqlfilter = '&cql_filter=Intersects(the_geom,Polygon((';
                 cqlfilter += coordstr.join(',');
                 cqlfilter += ')))';
                 if (type == 'circle'){
                       cqlfilter = '&cql_filter=DWithin(the_geom,Point(';
                       cqlfilter += geom[0].toString() + ' '+geom[1].toString()+'),';
                       var latitude = geom[1];
                       var radius = 0.90 * layer.getRadius()/(111.32 * 1000 * Math.cos(latitude * (3.1415926 / 180)));
                       cqlfilter += radius.toString() + ',kilometers)';
                 }
                 geourl += cqlfilter;
                 //alert(cqlfilter);
                 //alert(geourl);
                 //get source layer
                 $.ajax({
                       url: geourl,
                       jsonp: "callback",
                       dataType: "jsonp"
                 });
                 //get sink layer
                 var sinkurl='https://beta.simccs.org/geoserver/SimCCS/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=SimCCS:NATCARB_SALINE&maxFeatures=5000&outputFormat=text%2Fjavascript&format_options=callback:loadsinklayer';
                 sinkurl += cqlfilter;
                 $.ajax({
                       url: sinkurl,
                       jsonp: "callback",
                       dataType: "jsonp"
                 });
                 var sinkurl2='https://beta.simccs.org/geoserver/SimCCS/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=SimCCS:NATCARB_OG&maxFeatures=5000&outputFormat=text%2Fjavascript&format_options=callback:loadsinklayer2';
                 sinkurl2 += cqlfilter;
                 $.ajax({
                       url: sinkurl2,
                       jsonp: "callback",
                       dataType: "jsonp"
                 });
                 layer.remove();
                 //layer.setStyle({'color':'grey','fillOpacity': 0.0});
                 map.removeControl(drawControl);
                 layercontrol.addTo(map);
                 //hide allmap div
                 document.getElementById("allmap").style.display="none";
                 document.getElementById("workingarea").style.display="block";
                 // interface for non-login user
                 if (! userIsAuthenticated) {
                  document.getElementById("bn_generatemps").style.display="none";
                  document.getElementById("nologinuser_msg").style.display="block";
                  document.getElementById("southeastUS_div").style.display="block";
                  }
                  // pull the experiments result
                  if ( userIsAuthenticated) {
                  //document.getElementById("experiments_div").style.display="block";      
                  }

                 //testing code, add geotiff layer
                 var cost_image_url="https://beta.simccs.org/geoserver/ows?service=WCS&version=2.0.0&request=GetCoverage&coverageId=SimCCS__cost&format=png";
                 // &subset=Lat(29.920588,33.381122)&subset=Long(-89.251876,-83.277539)";
                 cost_image_url += "&subset=Lat(" +lbounds.getSouth() +","+lbounds.getNorth() +")";
                 cost_image_url += "&subset=Long("+lbounds.getWest() + ","+lbounds.getEast() + ")";
                 var cost_image_bounds = lbounds;
                 var cost_surface =L.imageOverlay(cost_image_url,cost_image_bounds).addTo(map);
                 layercontrol.addOverlay(cost_surface,"Cost");
            });
         
         
           };
         function hideunselected() {
            sourceLayer.eachLayer(function(layer) {
                  var target_id = selection.indexOf(layer);
                  if (target_id <0) {layer.remove();};
            });
            sinkLayer.eachLayer(function(layer) {
                  var target_id = sinkselection.indexOf(layer);
                  if (target_id <0) {layer.remove();};
            });
            sinkLayer2.eachLayer(function(layer) {
                  var target_id = sinkselection2.indexOf(layer);
                  if (target_id <0) {layer.remove();};
            });
         };

         function downloadcsv(text, name, type,hyperid) {
            var a = document.getElementById(hyperid);
            var file = new Blob([text], {type: type});
            a.href = URL.createObjectURL(file);
            a.download = name;
            }

         function generateinputfile(){
            // Facility_N City State Latitude Longitude Industry_T CO2_Emissi
            //ID costFix ($M) fixO&M ($M/y) varO&M ($/tCO2) capMax (MtCO2/y) N/A LON LAT NAME
            if (selection.length == 0 ) {alert('No soruces are selected!');return}
            var sourcedata = "ID\t(MtCO2/y)\tLON\tLAT\tNAME\n";
            var tempstr = "";
            for (i = 0; i < selection.length; i++) {
                  tempstr = "";
                  tempstr += (i+1).toString()+"\t";
                  tempstr += selection[i].feature.properties.CO2_Emissi +"\t";
                  tempstr += selection[i].feature.properties.Longitude +"\t";
                  tempstr += selection[i].feature.properties.Latitude +"\t";
                  tempstr += selection[i].feature.properties.Facility_N +"\t";
                  sourcedata += tempstr + "\n";
            } 
            //alert(sourcedata);

            //NATCARB_SALINE
            //Latitude 	Longitude 	Resource_A 	Depth__m_ 	Thickness_ 	CO2_Low__t 	CO2_Medium 	CO2_High__ 	Shape_Leng 	Shape_Are
            var sinkdata = "";
            sinkdata = "ID\tCO2_Low\tCO2_Med\tCO2_High\tDepth(m)\tThickness(m)\tLON\t\LAT\n";
            var sinkcount = sinkselection.length;
            //
            //var testinglayer = sinkselection[0];
            //alert((testinglayer.getBounds()).getCenter());
            var center_latlon;
            for (i = 0; i < sinkselection.length; i++) {
                  tempstr = "";
                  tempstr += (i+1).toString()+"\t";
                  tempstr += sinkselection[i].feature.properties.CO2_Low__t +"\t";
                  tempstr += sinkselection[i].feature.properties.CO2_Medium +"\t";
                  tempstr += sinkselection[i].feature.properties.CO2_High__ +"\t";
                  tempstr += sinkselection[i].feature.properties.Depth__m_ +"\t";
                  tempstr += sinkselection[i].feature.properties.Thickness_ +"\t";
                  center_latlon = (sinkselection[i].getBounds()).getCenter();
                  //lon lat
                  tempstr += center_latlon.lng +"\t";
                  tempstr += center_latlon.lat +"\t";  
                  sinkdata += tempstr + "\n";    
            }
            //NATCARB_OG
            //TOTAL_FIEL 	VOL_LOW 	VOL_MED 	VOL_HIGH 	Shape_Leng 	Shape_Ar
            for (i = 0; i < sinkselection2.length; i++) {
                  tempstr = "";
                  tempstr += (i+1+sinkcount).toString()+"\t";
                  tempstr += sinkselection2[i].feature.properties.VOL_LOW +"\t";
                  tempstr += sinkselection2[i].feature.properties.VOL_MED +"\t";
                  tempstr += sinkselection2[i].feature.properties.VOL_HIGH +"\t";
                  tempstr += "\t";
                  tempstr += "\t";               
                  // missing lat/lon information
                  center_latlon = (sinkselection2[i].getBounds()).getCenter();
                  //lon lat
                  tempstr += center_latlon.lng +"\t";
                  tempstr += center_latlon.lat +"\t";  
       sinkdata += tempstr + "\n";
            }

            //NATCARB_OG
            //TOTAL_FIEL 	VOL_LOW 	VOL_MED 	VOL_HIGH 	Shape_Leng 	Shape_Ar
            //sourceLayer.eachLayer(function(layer) {
            //
            //      var target_id = selection.indexOf(layer);
            //      if (target_id >=0) {alert(layer.feature.properties.Facility_N);};
            //});   
            downloadcsv(sourcedata, "Sources.txt", "text/plain","sources_input"); 
            downloadcsv(sinkdata, "Sinks.txt", "text/plain","sinks_input"); 
            
            document.getElementById("downloadsource_div").style.display="block";
            document.getElementById("downloadsink_div").style.display="block";
   
         }

         // ajax interface to generate candidate-network
         function generatecandidatenetwork() {
               // call url: /maptool/candidate-network/
               alert("ajax interface to generate candidate-network");
         }

         // ajax interface to generate MPS file
         function generatempsfile() {
            // demo code
            //id="bn_generatemps"
            // check user login
            //if (! userIsAuthenticated) {
            //      window.location.href = "/auth/login?next=/maptool";
            //      return; }
            $("#bn_generatemps").text('Generating ... !!!');
            $("#bn_generatemps").addClass('disabled');

   // $('#dynamicModal').on('hidden.bs.modal', function (e) {
   //     $(this).remove();
   // });
            $.getJSON( "/maptool/mps/", function( data ) {
                  //{"user_file": "MIP_Files/mip_2019-04-24T145902.mps"}
                  $("#bn_generatemps").text('Generate MPS file');
                  $("#bn_generatemps").removeClass('disabled');
                  //alert(data["user_file"] + " is generated succefully");
                  m_html =`<div class="modal fade in" id="dynamicModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Generate MPS file</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p><strong> user_file </strong> is generated succefully!.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary">
            <a href="/workspace/applications/Cplex_a7eaf483-ab92-4441-baeb-2f302ccb2919/create_experiment?Cplex-input-file=user_input_file&experiment-data-dir=results_dir" target=_ style="color:inherit">Create Project</a></button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>`;
      var teststr = data["user_file"];
      m_html = m_html.replace("user_file",teststr);
      m_html = m_html.replace("user_input_file",teststr)
      var results_dir = data["results_dir"];
      m_html = m_html.replace("results_dir", results_dir);
    $('body').append(m_html);
    $("#dynamicModal").modal();
    $("#dynamicModal").modal('show');

            });
         }

         function resetworkingarea(){
           document.getElementById("allmap").style.display="block";
           document.getElementById("workingarea").style.display="none";
           //layercontrol.removeLayer(sourceLayer);
           //layercontrol.removeLayer(sinkLayer);
           //layercontrol.removeLayer(sinkLayer2);
           //map.removeLayer(sourceLayer);
           //map.removeLayer(sinkLayer);
           //map.removeLayer(sinkLayer2);
           map.eachLayer(function (layer) {
                              //keep the basemap layer
                              if (layer != osm) {layercontrol.removeLayer(layer);map.removeLayer(layer);};
                              });
          layercontrol.remove();
          //layercontrol.layers()._update;
         };

      function display_experiment_result(experiment_id){
            $.getJSON( "/maptool/experiment-result/"+experiment_id, function( data ) {
            //$.getJSON( "/static/Data/experiment01.json", function( data ) {
                  var result_sinkLayer = new L.geoJSON(data["Sinks"], {
                  pointToLayer: function (feature, latlng) {
                  //var mypopup = L.popup().setContent(content_str);
                  var mymarker = L.circleMarker(latlng,{radius: 8,fillColor: "green",
                          color: "#000",weight: 1,opacity: 1,fillOpacity: 0.7});
                  //mymarker.bindPopup(mypopup);
                  return mymarker;       
                  }
            });
            var result_sourceLayer = new L.geoJSON(data["Sources"], {
                  pointToLayer: function (feature, latlng) {
                  //var mypopup = L.popup().setContent(content_str);
                  var mymarker = L.circleMarker(latlng,{radius: 8,fillColor: "red",
                          color: "#000",weight: 1,opacity: 1,fillOpacity: 0.7});
                  //mymarker.bindPopup(mypopup);
                  return mymarker;       
                  }
            });
            var result_networkLayer = new L.geoJSON(data["Network"],{style:{color:"blue",opacity:0.5,weight:4}});

            map.addLayer(result_sinkLayer);
            map.addLayer(result_sourceLayer);
            map.addLayer(result_networkLayer);
        //layercontrol.addOverlay(result_sinkLayer,"Sinks");
            });
      };

      // Load results from experiment as given in "?experiment_id=..." query parameter
      function load_current_experiment() {
          const urlParams = new URLSearchParams(window.location.search);
          const experimentId = urlParams.get('experiment_id');
          document.getElementById("allmap").style.display="none";
          document.getElementById("workingarea").style.display="block";
          display_experiment_result(experimentId);
          AiravataAPI.services.ExperimentService.retrieve({lookup: experimentId}).then(experiment => {
              render_experiment_list([experiment], [experimentId]);
          });
      }

      function render_experiment_list(experiments, selected_experiments) {
            var $experiments_div = $('#experiments_div');
            $experiments_div.empty();
            document.getElementById("experiments_div").style.display="block";
            experiments.forEach(experiment => {

              var $form_check = $('<div class="form-check"></div>');
              $experiments_div.append($form_check);
              var $input = $('<input class="form-check-input" type="checkbox">');
              if (selected_experiments.indexOf(experiment.experimentId) >= 0) {
                    $input.prop('checked', true);
              }
              $input.attr('id', experiment.experimentId);
              $input.attr('value', experiment.experimentId);
              $form_check.append($input);

              var $label = $('<label class="form-check-label"></label>');
              $label.attr('for', experiment.experimentId);
              $label.text(experiment.experimentName);
              $form_check.append($label);
            })
      }
      </script>
{% endblock scripts %}

{% block content %}

  <div class="main-content-wrapper">
    <main class="main-content">
      <div class="container-fluid">
      <!--<link rel="stylesheet" href="{% static 'css/mapTool.css' %}" type="text/css" />-->
      <div class="row main-row">
      <div class="col-md-3">
            <!--<div class="col-md-3  sidebar">-->
                  <div class="panel-group" id="allmap">
                      <div class="card border-info">
                        <div class="card-header bg-info text-light">
                              <strong>Source</strong>
                        </div>
                        <div class="card-body" >
                           <!--<label style="font-size: 12px;">Source</label>-->
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_chemical" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_chemical">Chemical</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_coal" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_coal">Coal</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_flourinated" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_flourinated">Flourinated GHCs</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_industrial_gas" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_industrial_gas">Industrial Gas</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_co2_injecton" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_co2_injecton">Co2 Injection</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_metals" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_metals">Metals</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_minerals" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_minerals">Minerals</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_natural_gas" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_natural_gas">Natural Gas</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_others" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_others">Others</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_petroleum" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_petroleum">Petroleum Products</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_petro_natural" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_petro_natural">Petroleum & Natural Gas</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_power_plants" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_power_plants">Power Plants</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_pulp_paper" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_pulp_paper">Pulp/Paper</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_refineries" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_refineries">Refineries</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_co2_suppliers" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_co2_suppliers">Co2 Suppliers</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_waste" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_waste">Waste</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_all_the_above" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_all_the_above">All the above</label>
                           </div>
                        </div>
                        <div class="card-footer"/>
                           <button type="button" class="btn btn-primary btn-sm btn-block" onclick="show_drawingtool()">Set up working area</button>
                        </div>
                  </div>
                      <div class="card border-info">
                        <div class="card-header bg-info text-light">
                              <strong>Sink</strong>
                        </div>
                        <div class="card-body" >
                              <div class="form-check">
                                 <input class="form-check-input" type="radio" id="sink_saline_formation">
                                 <label style="font-size: 100%;" class="form-check-label" for="sink_saline_formation">Saline Formation</label>
                              </div>
                              <div class="form-check">
                                 <input class="form-check-input" type="radio" id="sink_oil_reservoir">
                                 <label style="font-size: 100%;" class="form-check-label" for="sink_oil_reservoir">Oil/Gas Reservoir</label>
                              </div>
                              <div class="form-check">
                                 <input class="form-check-input" type="radio" id="sink_coal_reservoirs">
                                 <label style="font-size: 100%;" class="form-check-label" for="sink_coal_reservoirs">Unconventional Coal reservoirs</label>
                              </div>
                              <!--
                              <div class="form-check form-check-inline">
                                 <input class="form-check-input" type="radio" id="ordos_sink">
                                 <label style="font-size: 100%;" class="form-check-label" for="ordos_sink">Ordos Sink</label>
                              </div>
                              <div class="form-check form-check-inline">
                                 <input class="form-check-input" type="radio" id="france_sink">
                                 <label style="font-size: 100%;" class="form-check-label" for="france_sink">France Sink</label>
                              </div>
                              -->
                           </div>
                           <!----
                              <button type="button" class="btn btn-primary btn-sm btn-block" onclick="show_drawingtool()">Set up working area</button>
                                ---->
                        </div>
                      <div class="card border-info">
                        <div class="card-header bg-info text-light">
                              <strong>Pipeline Network</strong>
                        </div>
                        <div class="card-body" >
                                 <div class="form-check">
                                    <input class="form-check-input" type="radio" id="cost_surface">
                                    <label style="font-size: 100%" class="form-check-label" for="cost_surface">Cost Surface</label>
                                 </div>
                                 <div class="form-check">
                                    <input class="form-check-input" type="radio" id="candidate_network">
                                    <label style="font-size: 100%" class="form-check-label" for="candidate_network">Candidate Networks</label>
                                 </div>
                              </div>
                           </div>
               </div>
               <div id="workingarea" style="display: none;">
                      <div class="card border-info">
                        <div class="card-header bg-info text-light">
                              <strong>Workspace</strong>
                        </div>
                        <div class="card-body" >
               <button type="button" class="btn btn-primary btn-sm btn-block" onclick="hideunselected()">Hide unselcted data</button>
               <!-- <button type="button" class="btn btn-primary btn-sm btn-block" onclick="downloaddata()">Download data</button>
                  -->
               <button type="button" class="btn btn-primary btn-sm btn-block" onclick="generateinputfile()">Generate input file</button>
               <div id="downloadsource_div" style="display: none;"><a href="" id="sources_input">Download Source.txt</a></div>
               <div id="downloadsink_div" style="display: none;"><a href="" id="sinks_input">Download Sinks.txt</a></div>
               <br>
               <button type="button" id="bn_generatecandidatenetwork" class="btn btn-primary btn-sm btn-block" onclick="generatecandidatenetwork()">Generate Candidate Network</button>
               <button type="button" id="bn_generatemps" class="btn btn-primary btn-sm btn-block" onclick="generatempsfile()">Generate MPS file</button>
                <div id="nologinuser_msg" style="display: none;">Please <a href='/auth/login?next=/maptool'>login</a> to access all functions.</div>
               <br>  
               <button type="button" class="btn btn-primary btn-sm btn-block" onclick="resetworkingarea()">Reset working area</button>
               </div>
                      <div class="card border-info">
                        <div class="card-header bg-info text-light">
                              <strong>Results</strong>
                        </div>
                        <div class="card-body" >
                                    <div id="southeastUS_div" style="display:none">
                                    <input type="checkbox" id="checkbox_southeastUS" name="re_southeastUS" value="re_souteastUS" autocomplete="off" />
                                    <span class="default-font"><strong>SoutheastUS (Sample Scenario)</strong></span>
                                    </div>
                                    <div id="experiments_div" style="display:none">
                                                <input type="checkbox" id="checkbox_experiment_01" name="experiment_01" value="Cplex_on_Jun_3,_2019_4:34_PM_fe944263-db65-4a3c-a9c4-30f28967c3f1" autocomplete="off" />
                                                <span class="default-font"><strong>Cplex_on_Jun_3,_2019_4:34_PM_exp</strong></span>
                                    </div>
            
                        <br>
                        </div>
                  </div>
               </div>
               </div>
               </div>
               <div class="col-md-9">
                  <div id="map"></div>
               </div>
            </div>
         </div>
      </div>

      </div> <!-- container-fluid -->
    </main>
  </div>


{% endblock content %}
