{% extends "base.html" %}
{% load static %}

{% block css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/MarkerCluster.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/MarkerCluster_Default.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/leaflet.css' %}" />
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.css" />
<style type="text/css">
      #map{
      /*margin-left: 20px;*/
      /*margin-top: 60px;*/
      /*margin-top: 60px;*/
      width:99%;
      height:100% ;
      }
      .main-content {
            max-width: initial;
      }
      .container-fluid, .main-row {
            height: 100%;
      }
      .card {
            margin-bottom: 0px;
      }
      /* Allow vertical scrolling of sidebar if not enough room on screen */
      .main-row > .col-md-3 {
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
      }
</style>
{% endblock css %}

{% block scripts %}
<script src="{% static 'js/leaflet.js' %}"></script>
<script src="{% static 'js/leaflet.markercluster-src.js' %}"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.js"></script>
<script src="{% static 'js/leafletMap.js' %}" ></script>
<script src="{% static 'js/casestudies.js' %}" ></script>
<script src="{% static 'django_airavata_api/dist/airavata-api.js' %}"></script>
<script>
         // TODO: replace with global user session object
         var userIsAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};
         //var userIsAuthenticated = true;
         $(document).ready(function() {
      
           load_current_experiment();
           //map.addLayer(ordos_source_cluster);
           //map.addLayer(france_source_cluster);
         
         
         $('input:radio').bind('click mousedown', (function() {
             var isChecked;
             return function(event) {
                 if (event.type == 'click') {
                     radio_button_id=this.id;
                     if (isChecked) {
                         isChecked = this.checked = false;
                         switch(radio_button_id){
                             case "cost_surface":map.removeLayer(cost_surface_layer);
                                                 break;
                             case "source_sink_chemical":map.removeLayer(chemicalClusters)
                                   break;
                             case "source_sink_coal":map.removeLayer(coalClusters)
                                   break;
                             case "source_sink_flourinated":map.removeLayer(flourinatedClusters)
                                   break;
                             case "source_sink_industrial_gas":map.removeLayer(industrialGasClusters)
                                   break;
                             case "source_sink_co2_injecton":map.removeLayer(co2InjectionClusters)
                                   break;
                             case "source_sink_metals":map.removeLayer(metalClusters)
                                   break;
                             case "source_sink_minerals":map.removeLayer(mineralClusters)
                                   break;
                             case "source_sink_natural_gas":map.removeLayer(naturalGasClusters)
                                   break;
                             case "source_sink_others":map.removeLayer(otherClusters)
                                   break;
                             case "source_sink_petroleum":map.removeLayer(petroleumClusters)
                                   break;
                             case "source_sink_petro_natural":map.removeLayer(petroleumNaturalGasClusters)
                                   break;
                             case "source_sink_power_plants":map.removeLayer(powerPlantClusters)
                                   break;
                             case "source_sink_pulp_paper":map.removeLayer(pulpClusters)
                                   break;
                             case "source_sink_refineries":map.removeLayer(refineriesClusters)
                                   break;
                             case "source_sink_co2_suppliers":map.removeLayer(co2SupplyClusters)
                                   break;
                             case "source_sink_waste":map.removeLayer(wasteClusters)
                                   break;
                             case "source_sink_pulp_paper":map.removeLayer(chemicalClusters)
                                   break;
         
                             case "source_sink_all_the_above":
                                 map.removeLayer(chemicalClusters);
                                 map.removeLayer(coalClusters);
                                 map.removeLayer(flourinatedClusters);
                                 map.removeLayer(co2InjectionClusters);
                                 map.removeLayer(metalClusters);
                                 map.removeLayer(mineralClusters);
                                 map.removeLayer(naturalGasClusters);
                                 map.removeLayer(otherClusters);
                                 map.removeLayer(petroleumClusters);
                                 map.removeLayer(petroleumNaturalGasClusters);
                                 map.removeLayer(powerPlantClusters);
                                 map.removeLayer(pulpClusters);
                                 map.removeLayer(refineriesClusters);
                                 map.removeLayer(co2SupplyClusters);
                                 map.removeLayer(wasteClusters);
         
         
                                   break;
                              case "source_all_test":
                                    map.removeLayer(source_all_test_layer_1);
                                    break;
                             case "candidate_network":
                                                     map.removeLayer(ut_candidate_network);
                                                     map.removeLayer(albert_candidate_network);
                                                     map.removeLayer(illinios_candidate_network);
                                                     // map.removeLayer(ne_cadidate_network);
                                                     map.removeLayer(ordos_candidate_network);
                                                     map.removeLayer(se_candidate_network);
         
                                                     // map.remove(ne_cadidate_network);
                             break;
         
                             //
                             case "sink_coal_reservoirs":map.removeLayer(sink_coal_layer);
                             break;
                             case "sink_saline_formation":map.removeLayer(sink_sco2t_layer);
                             break;
                             case "sink_oil_reservoir":map.removeLayer(sink_oil_eor_layer);
                             break;
                             case "ordos_sink":map.removeLayer(sink_ordos_layer);
                             break;
                              case "france_sink":map.removeLayer(france_sink_cluster);
                             break;
         
                         }
         
                     } else {
                         isChecked = true;
                         switch(radio_button_id){
                             case "cost_surface":cost_surface_layer.addTo(map);
                                                 break;
                             case "source_sink_chemical":map.addLayer(chemicalClusters);
                                   break;
                             case "source_sink_coal":map.addLayer(coalClusters);
                                   break;
                             case "source_sink_flourinated":map.addLayer(flourinatedClusters);
                                   break;
                             case "source_sink_industrial_gas":map.addLayer(industrialGasClusters);
                                   break;
                             case "source_sink_co2_injecton":map.addLayer(co2InjectionClusters);
                                   break;
                             case "source_sink_metals":map.addLayer(metalClusters);
                                   break;
                             case "source_sink_minerals":map.addLayer(mineralClusters);
                                   break;
                             case "source_sink_natural_gas":map.addLayer(naturalGasClusters);
                                   break;
                             case "source_sink_others":map.addLayer(otherClusters);
                                   break;
                             case "source_sink_petroleum":map.addLayer(petroleumClusters);
                                   break;
                             case "source_sink_petro_natural":map.addLayer(petroleumNaturalGasClusters);
                                   break;
                             case "source_sink_power_plants":map.addLayer(powerPlantClusters);
                                   break;
                             case "source_sink_pulp_paper":map.addLayer(pulpClusters);
                                   break;
                             case "source_sink_refineries":map.addLayer(refineriesClusters);
                                   break;
                             case "source_sink_co2_suppliers":map.addLayer(co2SupplyClusters);
                                   break;
         
                             case "source_sink_waste":map.addLayer(wasteClusters);
                                   break;
         
         
         
                             case "source_sink_all_the_above":
                             map.addLayer(chemicalClusters);
                                 map.addLayer(coalClusters);
                                 map.addLayer(flourinatedClusters);
                                 map.addLayer(co2InjectionClusters);
                                 map.addLayer(metalClusters);
                                 map.addLayer(mineralClusters);
                                 map.addLayer(naturalGasClusters);
                                 map.addLayer(otherClusters);
                                 map.addLayer(petroleumClusters);
                                 map.addLayer(petroleumNaturalGasClusters);
                                 map.addLayer(powerPlantClusters);
                                 map.addLayer(pulpClusters);
                                 map.addLayer(refineriesClusters);
                                 map.addLayer(co2SupplyClusters);
                                 map.addLayer(wasteClusters);
                                 // map.addLayer(ordos_source_cluster);
                                 // map.addLayer(france_source_cluster);
         
         
                                   break;
                              
                            case "source_all_test":
                                  map.addLayer(source_all_test_layer_1);
                                  break;
         
                             case "candidate_network":
                             //
                             map.addLayer(albert_candidate_network);
                             map.addLayer(illinios_candidate_network);
                             map.addLayer(ne_cadidate_network);
                             map.addLayer(ordos_candidate_network);
                             //
                                 //se_candidate_network.addTo(map);
                                 //ut_candidate_network.addTo(map);
                                 //albert_candidate_network.addTo(map);
                                 //illinios_candidate_network.addTo(map);
                                 // // ne_cadidate_network.addTo(map);
                                 //ordos_candidate_network.addTo(map);
                                 // ne_cadidate_network.addTo(map);
                             break;
         
                             case "sink_coal_reservoirs":map.addLayer(sink_coal_layer);
                             break;
         
                             case "sink_saline_formation":map.addLayer(sink_sco2t_layer);
                             break;
                             case "sink_oil_reservoir":map.addLayer(sink_oil_eor_layer);
                             break;
                             case "ordos_sink":map.addLayer(sink_ordos_layer);
                             break;
                             case "france_sink":map.addLayer(france_sink_cluster);
                             break;
                         }
                     }
                 } else {
                     isChecked = this.checked;
                 }
             }
         })());
         
         // continue document ready funtion
            $('#checkbox_southeastUS').change(function(){
			if(this.checked) {
				//$('#southeastUS_div').show();
                        // clear map, remove all layers
                        map.eachLayer(function (layer) {
                              //keep the basemap layer
                              if (layer != osm) {map.removeLayer(layer);};
                              });
                        // load sample layers
                        display_result_sample();
                  }
                  else {
                        //$('#southeastUS_div').hide();
                        map.eachLayer(function (layer) {
                              //keep the basemap layer
                              if (layer != osm) {layercontrol.removeLayer(layer);map.removeLayer(layer);};
                              });
                        
                  }
            });
        // continue document ready funtion
        $('#experiments_div').on('change', 'input', function() {
            if(this.checked) {
				//$('#southeastUS_div').show();
                        // clear map, remove all layers
                        map.eachLayer(function (layer) {
                              //keep the basemap layer
                              if (layer != osm) {map.removeLayer(layer);};
                              });
                        // load sample layers
                        display_experiment_result(this.value);
                  }
                  else {
                        //$('#southeastUS_div').hide();
                        map.eachLayer(function (layer) {
                              //keep the basemap layer
                              if (layer != osm) {layercontrol.removeLayer(layer);map.removeLayer(layer);};
                              });  
                  }
            });
 
         });
         
         var geojsonMarkerOptions = {
         radius: 8,
         fillColor: "blue",
         color: "#000",
         weight: 1,
         opacity: 1,
         fillOpacity: 0.7,
         pane: "pointsPane"
         };
         
         var geojsonMarkerOptions_green = {
         radius: 8,
         fillColor: "green",
         color: "#000",
         weight: 1,
         opacity: 1,
         fillOpacity: 0.7,
         pane: "pointsPane"
         };
      
         var selection=[];
         var selection_green=[];
         var sinkselection=[];
         var sinkselection2=[];
         function sourceOnEachFeature(feature, layer) {
         //bind click
         layer.on('click', function (e) {
           var target_id = selection.indexOf(e.target)
           if (target_id >=0 ) {e.target.setStyle(geojsonMarkerOptions);selection.splice(target_id,1);}
           else {e.target.setStyle({weight:2,color:"white",fillColor:"purple",radius:12});
                 selection.push(e.target);}
         })};
         
         function sinkOnEachFeature(feature, layer) {
         //bind click
         //layer.bindTooltip("<strong>CO2_Low(t):"+feature.properties.CO2_Low__t.toString()+"<strong>");
         layer.bindTooltip("<strong>Name: "+feature.properties.Resource_N+"<br>"+"Min Total Sink Cost: "+feature.properties['Min_Total_'].toString()+"<strong>");
         layer.on('click', function (e) {
           var target_id = sinkselection.indexOf(e.target)
           if (target_id >=0 ) {e.target.setStyle({weight:1,color:'grey',fillOpacity:0.4});sinkselection.splice(target_id,1);}
           else {e.target.setStyle({weight:2,color:"white",fillOpacity:0.7});
                 sinkselection.push(e.target);}
         })};
         
         function sinkOnEachFeature2(feature, layer) {
         //bind click
         layer.bindTooltip("<strong>CO2_Low(t):"+feature.properties.VOL_LOW.toString()+"<strong>");
         layer.on('click', function (e) {
           var target_id = sinkselection2.indexOf(e.target)
           if (target_id >=0 ) {e.target.setStyle({weight:1,color:'grey',fillOpacity:0.4});sinkselection2.splice(target_id,1);}
           else {e.target.setStyle({weight:2,color:"white",fillOpacity:0.7});
                 sinkselection2.push(e.target);}
         })};
         
         var sourceLayer = new L.geoJSON('', {
         pointToLayer: function (feature, latlng) {
           var content_str="<strong>"+feature.properties.Type+"<br>"+feature.properties.Name +'<br>Total CO2: '+feature.properties['Total_CO2_']+"</strong>";
           //var mypopup = L.popup().setContent(content_str);
           var mymarker = L.circleMarker(latlng, geojsonMarkerOptions);
           //mymarker.bindPopup(mypopup);
           mymarker.bindTooltip(content_str);
           return mymarker;       
         },
         //pane: "pointsPane",
         onEachFeature: sourceOnEachFeature
         });
         
         var sinkLayer = new L.geoJSON('',{style: function(feature){
           var co2 = feature.properties['varO_M____'];
           var fillcolor = ''; 
           if (co2 >=3.0) {fillcolor = '#f50000';} 
           else if (co2 >=1.0 && co2 < 3) {fillcolor ='#fdff00'}
           else {fillcolor = '#00f905'}
           return {'color':'grey','weight':1,'fillColor':fillcolor,'fillOpacity': 0.3,pane: "polygonsPane"};
         },
         
         onEachFeature: sinkOnEachFeature
         })
         
         var sinkLayer2 = new L.geoJSON('',{style: function(feature){
           var co2 = feature.properties.VOL_LOW;
           var fillcolor = ''; 
           if (co2 >= 1 && co2 < 5e+06) {fillcolor = '#f50000';} 
           else if (co2 >=5e+06 && co2 < 5e+07) {fillcolor ='#fdff00'}
           else {fillcolor = '#00f905'}
           return {'color':'grey','weight':1,'fillColor':fillcolor,'fillOpacity': 0.3,pane: "polygonsPane"};
         },
         
         onEachFeature: sinkOnEachFeature2
         })
           function loadjson(data) {
                 sourceLayer.addData(data);
                 sourceLayer.addTo(map);
                 layercontrol.addOverlay(sourceLayer,"Sources");
           }
         
           function loadsinklayer(data) {
                 sinkLayer.addData(data);
                 sinkLayer.addTo(map);
                 layercontrol.addOverlay(sinkLayer,"Sinks:Saline");
                 //sinkLayer.bringToBack();
           }
           
           function loadsinklayer2(data) {
                 sinkLayer2.addData(data);
                 sinkLayer2.addTo(map);
                 layercontrol.addOverlay(sinkLayer2,"Sinks:Oil/Gas");
                 //sinkLayer.bringToBack();
           }
           //hard coded need to be rewrite later
           var case_sourceLayer = new L.geoJSON('', {
         pointToLayer: function (feature, latlng) {
           var content_str = "<strong>Type: Source</strong><br>";
           content_str += "<strong>"+"ID: " + feature.properties["ID"] +"</strong><br>";
           content_str +="<strong>"+"costFix ($M): " + feature.properties["costFix ($M)"] +"</strong><br>";
           content_str +="<strong>"+"fixO&M ($M\/y): " + feature.properties["fixO&M ($M\/y)"] +"</strong><br>";
           content_str +="<strong>"+"varO&M ($\/tCO2): " + feature.properties["varO&M ($\/tCO2)"] +"</strong><br>";
           content_str +="<strong>"+"capMax (MtCO2\/y): " + feature.properties["capMax (MtCO2\/y)"] +"</strong>";
           //var mypopup = L.popup().setContent(content_str);
           var mymarker = L.circleMarker(latlng, geojsonMarkerOptions);
           //mymarker.bindPopup(mypopup);
           mymarker.bindTooltip(content_str);
           return mymarker;       
         },
         //pane: "pointsPane",
         onEachFeature: sourceOnEachFeature
         });
      
           function case_loadsource(data) {
                 case_sourceLayer.addData(data);
                 case_sourceLayer.addTo(map);
                 layercontrol.addOverlay(case_sourceLayer,"Sources");
           }

           function sourceOnEachFeature_green(feature, layer) {
         //bind click
         layer.on('click', function (e) {
           var target_id = selection_green.indexOf(e.target)
           if (target_id >=0 ) {e.target.setStyle(geojsonMarkerOptions_green);selection_green.splice(target_id,1);}
           else {e.target.setStyle({weight:2,color:"white",fillColor:"yellow",radius:12});
                 selection_green.push(e.target);}
         })};

      var case_sinkLayer = new L.geoJSON('', {
         pointToLayer: function (feature, latlng) {
           var content_str = "<strong>Type: Sink</strong><br>";
           content_str += "<strong>"+"Name: " + feature.properties["field_17"] +"</strong><br>";
           //var mypopup = L.popup().setContent(content_str);
           var mymarker = L.circleMarker(latlng, geojsonMarkerOptions_green);
           //mymarker.bindPopup(mypopup);
           mymarker.bindTooltip(content_str);
           return mymarker;       
         },
         //pane: "pointsPane",
         onEachFeature: sourceOnEachFeature_green
         });

      function case_loadsink(data) {
                 case_sinkLayer.addData(data);
                 case_sinkLayer.addTo(map);
                 layercontrol.addOverlay(case_sinkLayer,"Sinks");
      }

      function case_hideunselected() {
            var btn_status = $("#case_hideunselected_btn").val();
            //alert(btn_status);
            if (btn_status == 'hide') {
                  case_sourceLayer.eachLayer(function(layer) {
                        var target_id = selection.indexOf(layer);
                        if (target_id <0) {layer.remove();};
                  });
                  case_sinkLayer.eachLayer(function(layer) {
                        var target_id = selection_green.indexOf(layer);
                        if (target_id <0) {layer.remove();};
                  }); 
                  $("#case_hideunselected_btn").html("Show unselected data");
                  $("#case_hideunselected_btn").val("unhide");}
            else {
                  case_sourceLayer.eachLayer(function(layer) {
                        var target_id = selection.indexOf(layer);
                        if (target_id <0) {layer.addTo(map);};
                  });
                  case_sinkLayer.eachLayer(function(layer) {
                        var target_id = selection_green.indexOf(layer);
                        if (target_id <0) {layer.addTo(map);};
                  }); 
                  $("#case_hideunselected_btn").html("Hide unselected data");
                  $("#case_hideunselected_btn").val("hide");
            }
      };
      
      function case_generateinputfile() {
            if (selection.length == 0 ) {alert('No soruces are selected!');return}
            if (selection_green.length == 0 ) {alert('No sinks are selected!');return}
            // write our source.txt
            var sourcedata = case_generatesourcedata();

            // generate generate Sinks.txt
            var sinkdata=case_generatesinkdata();
            downloadcsv(sourcedata, "Sources.txt", "text/plain","case_sources_input"); 
            downloadcsv(sinkdata, "Sinks.txt", "text/plain","case_sinks_input"); 
            document.getElementById("case_downloadsource_div").style.display="block";
            document.getElementById("case_downloadsink_div").style.display="block";
     
      }

      function case_generatesourcedata() {

            var sourcedata = "ID\tcostFix ($M)\tfixO&M ($M/y)\tvarO&M ($/tCO2)\tcapMax (MtCO2/y)\tN/A\tLON\tLAT\tNAME\n";
            var tempstr = "";
            for (i = 0; i < selection.length; i++) {
                  tempstr = "";
                  tempstr += (i+1).toString()+"\t";
                  tempstr += selection[i].feature.properties["costFix ($M)"]+"\t";
                  tempstr += selection[i].feature.properties["fixO&M ($M/y)"]+"\t";
                  tempstr += selection[i].feature.properties["varO&M ($/tCO2)"]+"\t";
                  tempstr += selection[i].feature.properties["capMax (MtCO2/y)"]+"\t";
                  tempstr += selection[i].feature.properties["N/A"]+"\t";
                  tempstr += selection[i].feature.properties["LON"]+"\t";
                  tempstr += selection[i].feature.properties["LAT"]+"\t";
                  tempstr += selection[i].feature.properties["NAME"]+"\t";
                  sourcedata += tempstr + "\n";
            }
            return sourcedata;
      }

      function case_generatesinkdata() {
            var sinkdata="0\t1\t2\t3\t4\t5\t6\t7\t8\t9\t10\t11\t12\t13\t14\t15\t16" + "\n";
            var entry;
            for (i = 0; i < selection_green.length; i++) {
                  tempstr = "";
                  entry = selection_green[i];
                  tempstr += (i+1).toString() +"\t";
                  tempstr += (i+1).toString() +"\t";
                  for (j = 3; j < 18; j++) {
                        tempstr += entry.feature.properties["field_"+j.toString()]+"\t";
                  }
                  sinkdata += tempstr + "\n";
            }
            return sinkdata;
      }
      
      function case_generatempsfile() {
            if (selection.length == 0 ) {alert('No sources are selected!');return}
            if (selection_green.length == 0 ) {alert('No sinks are selected!');return}
            var sourcedata = case_generatesourcedata();
            var sinkdata=case_generatesinkdata();

            var crf = $("#case_Capital_Recovery_Rate").val();
            var numYears = $("#case_Project_Period").val();
            var capacityTarget = $("#case_Capture_Target").val();
            var current_dataset_id = get_current_dataset_id();
            var data = {
                  crf: crf ? crf : 0.1,
                  numYears: numYears ? numYears : 10,
                  capacityTarget: capacityTarget ? capacityTarget : 5,
                  sources: sourcedata,
                  sinks: sinkdata,
                  dataset: current_dataset_id
            };
            AiravataAPI.utils.FetchUtils.showSpinner($.getJSON({url: "/maptool/mps/", data: data}, function( data ) {
                  //{"user_file": "MIP_Files/mip_2019-04-24T145902.mps"}
                  //alert(data["user_file"] + " is generated succefully");
                  var m_html =`<div class="modal fade in" id="dynamicModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Generate MPS file</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p><strong> user_file </strong> is generated successfully!.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary">
            <a href="/workspace/applications/{{ cplex_application_id }}/create_experiment?Cplex-input-file=user_input_file&experiment-data-dir=results_dir" style="color:inherit">Create Experiment</a></button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>`;
      var teststr = data["user_file"];
      m_html = m_html.replace("user_file",teststr);
      m_html = m_html.replace("user_input_file",teststr)
      var results_dir = data["results_dir"];
      m_html = m_html.replace("results_dir", results_dir);
    $('body').append(m_html);
    $("#dynamicModal").modal();
    $("#dynamicModal").modal('show');

            }));
      }

           
           //get the list of selected source layers
           function get_selectedsourcelayers(){
                  // find all radio button id start with "source_"
                  var queryfields=[];
                  var source_dict = {};
                  source_dict['source_sink_chemical']='SimCCS:Source_Chemicals';
                  source_dict['source_sink_coal']='SimCCS:Source_Coal-based_Liquid_Fuel_Supply';	
                  source_dict['source_sink_flourinated']='SimCCS:Source_Import_and_Export_of_Equipment_Containing_Fluorintaed_GHGs';
                  source_dict['source_sink_industrial_gas']='SimCCS:Source_Industrial_Gas_Suppliers';	
                  source_dict['source_sink_co2_injecton']='SimCCS:Source_Injection_of_CO2';	
                  source_dict['source_sink_metals']='SimCCS:Source_Metals';	
                  source_dict['source_sink_minerals']='SimCCS:Source_Minerals';	
                  source_dict['source_sink_natural_gas']='SimCCS:Source_Natural_Gas_and_Natural_Gas_Liquids_Suppliers';
                  source_dict['source_sink_others']='SimCCS:Source_Other';	
                  source_dict['source_sink_petroleum']='SimCCS:Source_Petroleum_Product_Suppliers';
                  source_dict['source_sink_petro_natural']='SimCCS:Source_Petroleum_and_Natural_Gas_Systems';
                  source_dict['source_sink_power_plants']='SimCCS:Source_Power_Plants';
                  source_dict['source_sink_pulp_paper']='SimCCS:Source_Pulp_and_Paper';
                  source_dict['source_sink_refineries']='SimCCS:Source_Refineries';
                  source_dict['source_sink_co2_suppliers']='SimCCS:Source_Suppliers_of_CO2';
                  source_dict['source_sink_waste']='SimCCS:Source_Waste';
                  //source_dict['source_all_test']='SimCCS_Sources_Snapper';
                  source_dict['source_all_test']='Sources_082819_SimCCS_Format';
                  //"source_sink_all_the_above"
                  $("*[id^='source']:visible").each(function() {
                        if (this.checked) {queryfields.push(source_dict[this.id]);}
                  });
                  return queryfields.join();
           }

           var drawControl=0;
           function show_drawingtool(){
                  var querylayers = '';
                  querylayers = get_selectedsourcelayers();
                 if (querylayers == ''){alert("Please select at least one source!"); return;} 
                 // Initialise the FeatureGroup to store editable layers
                 var editableLayers = new L.FeatureGroup();
                 map.addLayer(editableLayers);
         
                 var drawPluginOptions = {
                 position: 'topright',
                 draw: {
                 polygon: {
                       allowIntersection: false, // Restricts shapes to simple polygons
                       drawError: {
                       color: '#e1e100', // Color the shape will turn when intersects
                       message: '<strong>Oh snap!<strong> you can\'t draw that!' // Message that will show when intersect
                       },
                       shapeOptions: {
                       color: '#97009c'
                       }
                 },
                 // disable toolbar item by setting it to false
                 polyline: false,
                 circle: true, // Turns off this drawing tool
                 rectangle: true,
                 marker: false,
                 },
                 edit: {
                 featureGroup: editableLayers, //REQUIRED!!
                 remove: false
                 }};
                 // Initialise the draw control and pass it the FeatureGroup of editable layers
                 if (drawControl==0) {drawControl = new L.Control.Draw(drawPluginOptions);map.addControl(drawControl);};
                 var editableLayers = new L.FeatureGroup();
                 map.addLayer(editableLayers);
         
                 map.on('draw:created', function(e) {
                       // clear map, remove all layers
                       map.eachLayer(function (layer) {
                              //keep the basemap layer
                              if (layer != osm) {map.removeLayer(layer);};
                        });
                 var type = e.layerType,
                 layer = e.layer;
                 editableLayers.addLayer(layer);
                 var geom = layer.toGeoJSON()['geometry']['coordinates'];
                 if (type == 'circle') {layer.addTo(map);} 
                 var lbounds=layer.getBounds().pad(0.1);
                 //alert(lbounds.getCenter());
                 //alert(JSON.stringify(geom));
                 var coordstr=[];
                 for (i = 0, len = geom[0].length; i < len; i++) {
                 coordstr[i]= (geom[0][i].toString()).replace(',',' ');} 
                 //alert(coordstr.join(','));
                 var geourl='https://beta.simccs.org/geoserver/SimCCS/ows?service=WFS&version=1.0.0&request=GetFeature&maxFeatures=500&outputFormat=text%2Fjavascript&format_options=callback:loadjson';
                 geourl += '&typeName=' + querylayers;
                 var cqlfilter = '&cql_filter=Intersects(the_geom,Polygon((';
                 cqlfilter += coordstr.join(',');
                 cqlfilter += ')))';
                 if (type == 'circle'){
                       cqlfilter = '&cql_filter=DWithin(the_geom,Point(';
                       cqlfilter += geom[0].toString() + ' '+geom[1].toString()+'),';
                       var latitude = geom[1];
                       var radius = 0.90 * layer.getRadius()/(111.32 * 1000 * Math.cos(latitude * (3.1415926 / 180)));
                       cqlfilter += radius.toString() + ',kilometers)';
                 }
                 geourl += cqlfilter;
                 //alert(cqlfilter);
                 //alert(geourl);
                 //get source layer
                 $.ajax({
                       url: geourl,
                       jsonp: "callback",
                       dataType: "jsonp"
                 });
                 //get sink layer
                 var sinkurl='https://beta.simccs.org/geoserver/SimCCS/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=SimCCS:SCO2T_SALINE_Test&maxFeatures=5000&outputFormat=text%2Fjavascript&format_options=callback:loadsinklayer';
                 sinkurl += cqlfilter;
                 $.ajax({
                       url: sinkurl,
                       jsonp: "callback",
                       dataType: "jsonp"
                 });
                 var sinkurl2='https://beta.simccs.org/geoserver/SimCCS/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=SimCCS:NATCARB_OG&maxFeatures=5000&outputFormat=text%2Fjavascript&format_options=callback:loadsinklayer2';
                 sinkurl2 += cqlfilter;
                 //$.ajax({
                 //      url: sinkurl2,
                 //      jsonp: "callback",
                 //      dataType: "jsonp"
                 //});
                 layer.remove();
                 //layer.setStyle({'color':'grey','fillOpacity': 0.0});
                 map.removeControl(drawControl);
                 drawControl=0;
                 layercontrol.addTo(map);
                 //hide allmap div
                 document.getElementById("allmap").style.display="none";
                 document.getElementById("workingarea").style.display="block";
                 // interface for non-login user
                 if (! userIsAuthenticated) {
                  document.getElementById("loginuser_tools").style.display="none";
                  document.getElementById("nologinuser_msg").style.display="block";
                  //document.getElementById("southeastUS_div").style.display="block";
                  }
                  // pull the experiments result
                  if ( userIsAuthenticated) {
                  document.getElementById("loginuser_tools").style.display="block";      
                  document.getElementById("nologinuser_msg").style.display="none";
                  }

                 //testing code, add geotiff layer
                 var cost_image_url="https://beta.simccs.org/geoserver/ows?service=WCS&version=2.0.0&request=GetCoverage&coverageId=SimCCS__cost&format=png";
                 // &subset=Lat(29.920588,33.381122)&subset=Long(-89.251876,-83.277539)";
                 cost_image_url += "&subset=Lat(" +lbounds.getSouth() +","+lbounds.getNorth() +")";
                 cost_image_url += "&subset=Long("+lbounds.getWest() + ","+lbounds.getEast() + ")";
                 var cost_image_bounds = lbounds;
                 var cost_surface =L.imageOverlay(cost_image_url,cost_image_bounds).addTo(map);
                 layercontrol.addOverlay(cost_surface,"Cost");
            });
         
         
           };
         function hideunselected() {
            sourceLayer.eachLayer(function(layer) {
                  var target_id = selection.indexOf(layer);
                  if (target_id <0) {layer.remove();};
            });
            sinkLayer.eachLayer(function(layer) {
                  var target_id = sinkselection.indexOf(layer);
                  if (target_id <0) {layer.remove();};
            });
            sinkLayer2.eachLayer(function(layer) {
                  var target_id = sinkselection2.indexOf(layer);
                  if (target_id <0) {layer.remove();};
            });
         };

         function downloadcsv(text, name, type,hyperid) {
            var a = document.getElementById(hyperid);
            var file = new Blob([text], {type: type});
            a.href = URL.createObjectURL(file);
            a.download = name;
            }

         function generateinputfile(){
            // Facility_N City State Latitude Longitude Industry_T CO2_Emissi
            //ID costFix ($M) fixO&M ($M/y) varO&M ($/tCO2) capMax (MtCO2/y) N/A LON LAT NAME
            if (selection.length == 0 ) {alert('No sources are selected!');return}
            if (sinkselection.length == 0 ) {alert('No sinks are selected!');return}
            var sourcedata = generatesourcedata();
            //alert(sourcedata);

            var sinkdata=generatesinkdata();

            downloadcsv(sourcedata, "Sources.txt", "text/plain","sources_input"); 
            downloadcsv(sinkdata, "Sinks.txt", "text/plain","sinks_input"); 
            
            document.getElementById("downloadsource_div").style.display="block";
            document.getElementById("downloadsink_div").style.display="block";
   
         }

         function generatesourcedata() {

            var sourcedata = "ID\tcostFix ($M)\tfixO&M ($M/y)\tvarO&M ($/tCO2)\tcapMax (MtCO2/y)\tN/A\tLON\tLAT\tNAME\n";
            var tempstr = "";
            for (i = 0; i < selection.length; i++) {
                  tempstr = "";
                  tempstr += (i+1).toString()+"\t";
                  tempstr += selection[i].feature.properties["costFix___"]+"\t";
                  tempstr += selection[i].feature.properties["fixO_M___m"]+"\t";
                  tempstr += selection[i].feature.properties["costVar___"]+"\t";
                  tempstr += selection[i].feature.properties["Capturable"]+"\t";
                  //tempstr += selection[i].feature.properties["N/A"]+"\t";
                  // N/A is set to 1
                  tempstr += "1"+"\t";
                  tempstr += selection[i].feature.properties["X"]+"\t";
                  tempstr += selection[i].feature.properties["Y"]+"\t";
                  // NAME is set same as ID
                  tempstr += (i+1).toString();
                  sourcedata += tempstr + "\n";
            } 
            return sourcedata;
         }

         function generatesinkdata() {

            //NATCARB_SALINE
            var sinkdata="0\t1\t2\t3\t4\t5\t6\t7\t8\t9\t10\t11\t12\t13\t14\t15\t16" + "\n";
            var sinkcount = sinkselection.length;

            var center_latlon;
            for (i = 0; i < sinkselection.length; i++) {
                  tempstr = "";
                  // field 0-1: ID
                  tempstr += (i+1).toString()+"\t";
                  tempstr += (i+1).toString()+"\t";
                  //2: Capacity "fieldCap__"
                  tempstr += sinkselection[i].feature.properties['fieldCap__'] + "\t";
                  //3: OpeningCost "costFix___"
                  tempstr += sinkselection[i].feature.properties['costFix___'] + "\t";
                  //4: OMCost "fixO_M___M"
                  tempstr += sinkselection[i].feature.properties['fixO_M___M'] + "\t";
                  //5: WellCapacity "wellCap__M"
                  tempstr += sinkselection[i].feature.properties['wellCap__M'] + "\t";
                  //6: WellOpeningCost "wellCostFi"
                  tempstr += sinkselection[i].feature.properties['wellCostFi'] + "\t";
                  //7: WellOMCost "wellFixO_M"
                  tempstr += sinkselection[i].feature.properties['wellFixO_M'] + "\t";
                  //8: InjectionCost "varO_M____"
                  tempstr += sinkselection[i].feature.properties['varO_M____'] + "\t";
                  //9: 0
                  tempstr += '0' + "\t";
                  //10: Lon "LON"
                  tempstr += sinkselection[i].feature.properties['LON'] + "\t";
                  //11: Lat "LAT"
                  tempstr += sinkselection[i].feature.properties['LAT'] + "\t";
                  //12: 0 
                  tempstr += '0' + "\t";
                  //13: 0
                  tempstr += '0' + "\t";
                  //14: 0
                  tempstr += '0' + "\t";
                  //15: 0
                  tempstr += '0' + "\t";
                  //16: NAME "NAME"
                  tempstr += sinkselection[i].feature.properties['NAME'];

                  //caculate lon lat
                  //center_latlon = (sinkselection[i].getBounds()).getCenter();
                  //tempstr += center_latlon.lng +"\t";
                  //tempstr += center_latlon.lat +"\t";  
                 
                  sinkdata += tempstr + "\n";    
            }
            return sinkdata;
         }

         var candidateNetworkLayer = L.geoJSON(null, {style:{color:"blue",opacity:0.5,weight:4}});
         var candidateNetworkLayerAddedToControl = false;
         // ajax interface to generate candidate-network
         function generatecandidatenetwork() {
            var sourcedata = generatesourcedata();
            var sinkdata=generatesinkdata();
            var data = {
                  sources: sourcedata,
                  sinks: sinkdata,
            };
            AiravataAPI.utils.FetchUtils.showSpinner($.getJSON({url: "/maptool/candidate-network/", data: data}, function( data ) {
                  // Note: 'data' includes Sinks and Sources but since those are
                  // already displayed I'm opting to only display the Network
                  candidateNetworkLayer.clearLayers();
                  candidateNetworkLayer.addData(data["Network"]);
                  if (!map.hasLayer(candidateNetworkLayer)) {
                        candidateNetworkLayer.addTo(map);
                  }
                  if (!candidateNetworkLayerAddedToControl) {
                        layercontrol.addOverlay(candidateNetworkLayer, "Candidate Network");
                        candidateNetworkLayerAddedToControl = true;
                  }
            }));
         }

         // ajax interface to generate MPS file
         function generatempsfile() {
            // demo code
            //id="bn_generatemps"
            // check user login
            //if (! userIsAuthenticated) {
            //      window.location.href = "/auth/login?next=/maptool";
            //      return; }

   // $('#dynamicModal').on('hidden.bs.modal', function (e) {
   //     $(this).remove();
   // });
            if (selection.length == 0 ) {alert('No sources are selected!');return}
            if (sinkselection.length == 0 ) {alert('No sinks are selected!');return}
            var sourcedata = generatesourcedata();
            var sinkdata=generatesinkdata();
            var crf = $("#Capital_Recovery_Rate").val();
            var numYears = $("#Project_Period").val();
            var capacityTarget = $("#Capture_Target").val();
            var data = {
                  crf: crf ? crf : 0.1,
                  numYears: numYears ? numYears : 10,
                  capacityTarget: capacityTarget ? capacityTarget : 5,
                  sources: sourcedata,
                  sinks: sinkdata,
            };
            AiravataAPI.utils.FetchUtils.showSpinner($.getJSON({url: "/maptool/mps/", data: data}, function( data ) {
                  //{"user_file": "MIP_Files/mip_2019-04-24T145902.mps"}
                  //alert(data["user_file"] + " is generated succefully");
                  m_html =`<div class="modal fade in" id="dynamicModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Generate MPS file</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p><strong> user_file </strong> is generated successfully!.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary">
            <a href="/workspace/applications/{{ cplex_application_id }}/create_experiment?Cplex-input-file=user_input_file&experiment-data-dir=results_dir" style="color:inherit">Create Experiment</a></button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>`;
      var teststr = data["user_file"];
      m_html = m_html.replace("user_file",teststr);
      m_html = m_html.replace("user_input_file",teststr)
      var results_dir = data["results_dir"];
      m_html = m_html.replace("results_dir", results_dir);
    $('body').append(m_html);
    $("#dynamicModal").modal();
    $("#dynamicModal").modal('show');

            }));
         }

         function resetworkingarea(){
           document.getElementById("allmap").style.display="block";
           document.getElementById("workingarea").style.display="none";
           //layercontrol.removeLayer(sourceLayer);
           //layercontrol.removeLayer(sinkLayer);
           //layercontrol.removeLayer(sinkLayer2);
           //map.removeLayer(sourceLayer);
           //map.removeLayer(sinkLayer);
           //map.removeLayer(sinkLayer2);
           map.eachLayer(function (layer) {
                              //keep the basemap layer
                              if (layer != osm) {layercontrol.removeLayer(layer);map.removeLayer(layer);};
                              });
          layercontrol.remove();
          //layercontrol.layers()._update;
         };

      function display_experiment_result(experiment_id){
            AiravataAPI.utils.FetchUtils.showSpinner($.getJSON( "/maptool/experiment-result/"+experiment_id, function( data ) {
            //$.getJSON( "/static/Data/experiment01.json", function( data ) {
                  var result_sinkLayer = new L.geoJSON(data["Sinks"], {
                  pointToLayer: function (feature, latlng) {
                  //var mypopup = L.popup().setContent(content_str);
                  var mymarker = L.circleMarker(latlng,{radius: 8,fillColor: "green",
                          color: "#000",weight: 1,opacity: 1,fillOpacity: 0.7});
                  //mymarker.bindPopup(mypopup);
                  return mymarker;       
                  }
            });
            var result_sourceLayer = new L.geoJSON(data["Sources"], {
                  pointToLayer: function (feature, latlng) {
                  //var mypopup = L.popup().setContent(content_str);
                  var mymarker = L.circleMarker(latlng,{radius: 8,fillColor: "red",
                          color: "#000",weight: 1,opacity: 1,fillOpacity: 0.7});
                  //mymarker.bindPopup(mypopup);
                  return mymarker;       
                  }
            });
            var result_networkLayer = new L.geoJSON(data["Network"],{style:{color:"blue",opacity:0.5,weight:4}});

            map.addLayer(result_sinkLayer);
            map.addLayer(result_sourceLayer);
            map.addLayer(result_networkLayer);
        //layercontrol.addOverlay(result_sinkLayer,"Sinks");
            }));

            AiravataAPI.utils.FetchUtils.showSpinner($.getJSON( "/maptool/solution-summary/"+experiment_id, function( data ) {
                  display_solution_summary(data);
            }));
      };

      // Load results from experiment as given in "?experiment_id=..." query
      // parameter if it exists and the user is authenticated
      function load_current_experiment() {
          const urlParams = new URLSearchParams(window.location.search);
          const experimentId = urlParams.get('experiment_id');
          if (experimentId && userIsAuthenticated) {
            document.getElementById("allmap").style.display="none";
            document.getElementById("workingarea").style.display="block";
            display_experiment_result(experimentId);
            AiravataAPI.services.ExperimentService.retrieve({lookup: experimentId}).then(experiment => {
                  render_experiment_list([experiment], [experimentId]);
            });
          }
      }

      function render_experiment_list(experiments, selected_experiments) {
            $("#model-results").show();
            var $experiments_div = $('#experiments_div');
            $experiments_div.empty();
            document.getElementById("experiments_div").style.display="block";
            experiments.forEach(experiment => {

              var $form_check = $('<div class="form-check"></div>');
              $experiments_div.append($form_check);
              var $input = $('<input class="form-check-input" type="checkbox">');
              if (selected_experiments.indexOf(experiment.experimentId) >= 0) {
                    $input.prop('checked', true);
              }
              $input.attr('id', experiment.experimentId);
              $input.attr('value', experiment.experimentId);
              $form_check.append($input);

              var $label = $('<label class="form-check-label"></label>');
              $label.attr('for', experiment.experimentId);
              $label.text(experiment.experimentName);
              $form_check.append($label);
            })
      }

      function display_solution_summary(data) {
            $("#solution-summary").show();
            $("#solution-summary-sources").text(data.numOpenedSources);
            $("#solution-summary-sinks").text(data.numOpenedSinks);
            $("#solution-summary-targetCaptureAmount").text(Math.round(data.targetCaptureAmount * 100) / 100);
            $("#solution-summary-edges").text(data.numEdgesOpened);
            $("#solution-summary-projectLength").text(data.projectLength);
            $("#solution-summary-totalCapture").text(Math.round(data.totalCaptureCost * 100) / 100);
            $("#solution-summary-unitCapture").text(Math.round(data.unitCaptureCost * 100) / 100);
            $("#solution-summary-totalTransport").text(Math.round(data.totalTransportCost * 100) / 100);
            $("#solution-summary-unitTransport").text(Math.round(data.unitTransportCost * 100) / 100);
            $("#solution-summary-totalStorage").text(Math.round(data.totalStorageCost * 100) / 100);
            $("#solution-summary-unitStorage").text(Math.round(data.unitStorageCost * 100) / 100);
            $("#solution-summary-totalCost").text(Math.round(data.totalCost * 100) / 100);
            $("#solution-summary-unitCost").text(Math.round(data.unitTotalCost * 100) / 100);
      }

      // global variable to record current case
      var current_case = {}; 
      function case_studies(val) {
            current_case ['case']= val;
            //look for val.json file
            document.getElementById("allmap").style.display="none";
            document.getElementById("case_studies_div").style.display="block";
            //hard coded only the demo purpose
            var summary_json = '';
            var case_folder = '';
            switch (val) {
                  case "Southeast_US":
                        $( "#case_studies_title" ).text("Southeast US");
                         case_folder = "SoutheastUS";
                         summary_json = "summary.json";
                        display_case_study(case_folder, summary_json);
                        //pan to a location for better view
                        map.setView([32.2611,-86.08615]);
                        break;
                  case "Midwest_2011_3":
                        $( "#case_studies_title" ).text("Midwest 2011");
                        case_folder = "3_2011_Midwest";
                        summary_json = "summary.json";
                        display_case_study(case_folder, summary_json);
                        map.setView([40.0,-84.29]);
                        break;
                  case "GulfCoast_2013_4":
                        $( "#case_studies_title" ).text("GulfCoast 2013");
                        case_folder = "4_2013_GulfCoast";
                        summary_json = "summary.json";
                        display_case_study(case_folder, summary_json);
                        map.setView([32.89,-95.69]);
                        break;
                  default:
                        return;
            }

            document.getElementById("case_studies_display_body").style.display="block";

            if (! userIsAuthenticated) {
                              document.getElementById("case_loginuser").style.display="none";
                              document.getElementById("case_nologinuser_msg").style.display="block";
                        }
                        if (userIsAuthenticated) {
                              document.getElementById("case_loginuser").style.display="block";
                              document.getElementById("case_nologinuser_msg").style.display="none";
                        }
           
      }
      
      //ednbale user edit the existing case
      function user_edit_case(val){ 
            // clear map
            map.eachLayer(function (layer) {
                              //keep the basemap layer
                              if (layer != osm) {map.removeLayer(layer);layercontrol.removeLayer(layer);};
                              });
            //hide the summary div, show edit div
            document.getElementById("case_studies_display_body").style.display = "none";
            document.getElementById("case_studies_editor_Southeast_US").style.display = "block";
            
            //alert(current_case['case']);
            //alert(current_case['sources']);
            //alert(current_case['sinks']);
            // load input_source.geojson input_sink.geojson for editing
            $.getJSON(current_case['sources'],function (data) {case_loadsource(data); });
            $.getJSON(current_case['sinks'], function (data) {case_loadsink(data); });
            //re-load candidnetwork
            $.getJSON(current_case['candidatenetwork'],function (data) {
                    var result_candidnetworkLayer = new L.geoJSON(data,{style:{color:"black",opacity:0.5,weight:1,pane:"linesPane"}});
                    map.addLayer(result_candidnetworkLayer);
                    layercontrol.addOverlay(result_candidnetworkLayer,"Candidate");   
                    //alert(result_candidnetworkLayer._leaflet_id);            
                });

      }

      // display search result
      var searchlayer;
      function loadsearchresult(data) {
            if (map.hasLayer(searchlayer)) {map.removeLayer(searchlayer);}
            if (data["totalFeatures"] > 0) {
                  searchlayer = L.geoJSON(data, { pointToLayer: function (feature, latlng) {
                        var content_str = "";
                        content_str += "<strong>"+"Name: " + feature.properties["Name"] +"</strong><br>";
                        content_str +="<strong>"+"Type: " + feature.properties["Type"] +"</strong><br>";
                        content_str +="<strong>"+"costVar($/tCO2): " + feature.properties["costVar___"] +"</strong><br>";
                        content_str +="<strong>"+"Capturable(MtCO2/y): " + feature.properties["Capturable"] +"</strong>";
                        //var mypopup = L.popup().setContent(content_str);
                        var mymarker = L.marker(latlng);
                        //mymarker.bindPopup(mypopup);
                        mymarker.bindTooltip(content_str);
                        return mymarker;       
                        }
                  });

                  map.addLayer(searchlayer);
                  map.fitBounds(searchlayer.getBounds()); }
            else {
                  alert("Zero source is found!");
            }
      }

      //A simple seach function
      function showSearchResults(layerid, searchstring) {
            var searchlayer;
            switch(layerid) {
                  case "source_all_test":
                        searchlayer = 'Sources_082819_SimCCS_Format';
                        break;
                  default:
                        searchlayer='';
            }
            //get json display as marker
            var geourl='https://beta.simccs.org/geoserver/SimCCS/ows?service=WFS&version=1.0.0&request=GetFeature&maxFeatures=500&outputFormat=text%2Fjavascript&format_options=callback:loadsearchresult';
            geourl += '&typeName=' + searchlayer;
            geourl += "&cql_filter=strToLowerCase(Name) like '" + encodeURIComponent("%" + searchstring + "%'");
            //alert(geourl);
            $.ajax({
                       url: geourl,
                       jsonp: "callback",
                       dataType: "jsonp"
                 });
      } 

</script>
{% endblock scripts %}

{% block content %}

  <div class="main-content-wrapper">
    <main class="main-content">
      <div class="container-fluid">
      <!--<link rel="stylesheet" href="{% static 'css/mapTool.css' %}" type="text/css" />-->
      <div class="row main-row">
      <div class="col-md-3">
            <!--<div class="col-md-3  sidebar">-->
                  <div class="panel-group" id="allmap">
                        <div class="card-body" bg-info text-light">
                              <div class="dropdown">
                                          <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                SimCCS Community Case Studies
                                          </button>
                                          <div class="dropdown-menu" id="case_studies_menu" aria-labelledby="dropdownMenuButton">
                                            <button class="dropdown-item" value="Southeast_US" onclick="case_studies(this.value)">Southeast US</button>
                                            <button class="dropdown-item" value="Midwest_2011_3" onclick="case_studies(this.value)">Midwest 2011</button>
                                            <button class="dropdown-item" value="GulfCoast_2013_4" onclick="case_studies(this.value)">GulfCoast 2013</button>   
                                          </div>
                              </div>
                        </div>
                  <div class="card border-info">
                        <div class="card-header bg-info text-light">
                              <strong>CO<sub>2</sub> Source Data</strong>
                        </div>
                        <div class="card-body" >
                           <!--<label style="font-size: 12px;">Source</label>-->
                           <!--
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_chemical" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_chemical">Chemical</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_coal" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_coal">Coal</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_flourinated" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_flourinated">Flourinated GHCs</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_industrial_gas" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_industrial_gas">Industrial Gas</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_co2_injecton" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_co2_injecton">Co2 Injection</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_metals" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_metals">Metals</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_minerals" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_minerals">Minerals</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_natural_gas" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_natural_gas">Natural Gas</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_others" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_others">Others</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_petroleum" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_petroleum">Petroleum Products</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_petro_natural" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_petro_natural">Petroleum & Natural Gas</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_power_plants" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_power_plants">Power Plants</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_pulp_paper" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_pulp_paper">Pulp/Paper</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_refineries" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_refineries">Refineries</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_co2_suppliers" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_co2_suppliers">Co2 Suppliers</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_waste" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_waste">Waste</label>
                           </div>
                           <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_sink_all_the_above" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_sink_all_the_above">All the above</label>
                           </div>
                        -->
                        <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" id="source_all_test" autocomplete="off">
                              <label style="font-size: 100%;" class="form-check-label" for="source_all_test">Sources for Testing</label>
                        </div>
                        <br><small>(Sources_082819_SimCCS_Format)</small>
                        <div id="seach_source_div"><input type="text" placeholder="search by name" name="searchString" id="search-string-value" size="20" value="" onchange="showSearchResults('source_all_test',this.value)" /></div>
                        <div><img src="/static/images/sources_snapper_legend.jpg" alt="source_legend" width="80%" height="80%" style="border:1px solidblack"> </div>
                        </div>
                  </div>
                  <div class="card border-info">
                        <div class="card-header bg-info text-light">
                              <strong>Pipeline Transport Data</strong>
                        </div>
                        <div class="card-body" >
                                 <div class="form-check">
                                    <input class="form-check-input" type="radio" id="cost_surface">
                                    <label style="font-size: 100%" class="form-check-label" for="cost_surface">Cost Surface</label>
                                    <br><small>Darker color indicates higher cost.</small>
                                 </div>
                                 <div class="form-check">
                                    <input class="form-check-input" type="radio" id="candidate_network">
                                    <label style="font-size: 100%" class="form-check-label" for="candidate_network">Candidate Networks</label>
                                 </div>
                              </div>
                           </div>
                      <div class="card border-info">
                        <div class="card-header bg-info text-light">
                              <strong>Storage and Utilization Sink Data</strong>
                        </div>
                        <div class="card-body" >
                              <div class="form-check">
                                 <input class="form-check-input" type="radio" id="sink_saline_formation">
                                 <label style="font-size: 100%;" class="form-check-label" for="sink_saline_formation">Saline Formation</label>
                                 <br> <small>(SCO2T_Database_v2_2)</small>
                                 <div><img src="/static/images/Saline_legend.jpg" alt="saline_legend" width="130px" height="100px" style="border:1px solidblack"> </div>
                              </div>
                              <div class="form-check">
                                 <input class="form-check-input" type="radio" id="sink_oil_reservoir" >
                                 <label style="font-size: 100%;" class="form-check-label" for="sink_oil_reservoir">Oil/Gas Reservoir</label>
                                 <br><small>(NATCARB_OG_082819)</small>
                                 <div><img src="/static/images/OG_legend.jpg" alt="saline_legend" width="114px" height="96px" style="border:1px solidblack"> </div>
                              </div>
                              <!--
                              <div class="form-check">
                                 <input class="form-check-input" type="radio" id="sink_coal_reservoirs" disabled>
                                 <label style="font-size: 100%;" class="form-check-label" for="sink_coal_reservoirs">Unconventional Coal reservoirs</label>
                              </div>
                              -->
                              <!--
                              <div class="form-check form-check-inline">
                                 <input class="form-check-input" type="radio" id="ordos_sink">
                                 <label style="font-size: 100%;" class="form-check-label" for="ordos_sink">Ordos Sink</label>
                              </div>
                              <div class="form-check form-check-inline">
                                 <input class="form-check-input" type="radio" id="france_sink">
                                 <label style="font-size: 100%;" class="form-check-label" for="france_sink">France Sink</label>
                              </div>
                              -->
                           </div>
                           <!----
                              <button type="button" class="btn btn-primary btn-sm btn-block" onclick="show_drawingtool()">Set up working area</button>
                                ---->
                              <div class="card-footer"/>
                                <button type="button" class="btn btn-primary btn-sm btn-block btn-success" onclick="show_drawingtool()">Set up working area<center>Using drawing tool <img src="/static/images/drawing_tool.jpg"  alt="drawing-tool" /> </center></button>
                                
                            </div>
     
                  </div>
               </div>
               <!-- working area div-->
               <div id="workingarea" style="display: none;">
                  <div class="card border-info">
                        <div class="card-header bg-info text-light">
                              <strong>Data Selection</strong>
                        </div>
                        <div class="card-body" >
                                    Use mouse-click to select source and sink data.<br>
                                    <button type="button" class="btn btn-primary btn-sm btn-block" onclick="hideunselected()">Hide unselected data</button>
                                    <!-- <button type="button" class="btn btn-primary btn-sm btn-block" onclick="downloaddata()">Download data</button>
                                       -->
                                    <button type="button" class="btn btn-primary btn-sm btn-block" onclick="generateinputfile()">Generate Data Files</button>
                                    <div id="downloadsource_div" style="display: none;"><a href="" id="sources_input">Download Source.txt</a></div>
                                    <div id="downloadsink_div" style="display: none;"><a href="" id="sinks_input">Download Sinks.txt</a></div>
                                    <br>
                                    <button type="button" class="btn btn-primary btn-sm btn-block" onclick="resetworkingarea()">Reset Area of Interest</button>
                                               
                        </div>
                  </div>
                  <div class="card border-info">
                        <div class="card-header bg-info text-light">
                              <strong>SimCCS User Workspace</strong>
                        </div>
                        <div class="card-body" >
                  <div id="loginuser_tools">
                        <button type="button" id="bn_generatecandidatenetwork" class="btn btn-primary btn-sm btn-block" onclick="generatecandidatenetwork()">Generate Candidate Network</button>
                        <hr/>
                        <strong>Model Parameters</strong><br>
                        <table>
                                    <tr><td>Capital Recovery Rate</td><td><input id="Capital_Recovery_Rate" name="Capital_Recovery_Rate" type="text" size=8 value="0.1" required></td></tr>
                                    <tr><td>Project Period (yrs)</td><td><input id="Project_Period" name="Project_Period" type="text" size=8 value="10" required></td></tr>
                                    <tr><td>Capture Target (MT/y)</td><td><input id="Capture_Target" name="Capture_Target" type="text" size=8 value="5" required></td></tr>
                        </table><br>
                        <button type="button" id="bn_generatemps" class="btn btn-primary btn-sm btn-block" onclick="generatempsfile()">Generate MPS file</button>
                  </div>
               <div id="nologinuser_msg" style="display: none;">Gateway user account required. <a href='/auth/login?next=/maptool/test/'>Login</a>&nbsp;to create SimCCS model scenarios.</div>
               </div>
                      <div class="card border-info" id="model-results" style="display: none;">
                        <div class="card-header bg-info text-light">
                              <strong>Results</strong>
                        </div>
                        <div class="card-body" >
                                    <div id="southeastUS_div" style="display:none">
                                    <input type="checkbox" id="checkbox_southeastUS" name="re_southeastUS" value="re_souteastUS" autocomplete="off" />
                                    <span class="default-font"><strong>SoutheastUS (Sample Scenario)</strong></span>
                                    </div>
                                    <div id="solution-summary" style="display:none">
                                          <p class="mb-2">
                                                <strong>Solution Summary</strong>
                                          </p>
                                          <table class="table table-sm">
                                                <tbody>
                                                <tr>
                                                      <th scope="row">Sources</th>
                                                      <td id="solution-summary-sources">1</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">Sinks</th>
                                                      <td id="solution-summary-sinks">4</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">CO<sub>2</sub> Stored</th>
                                                      <td id="solution-summary-targetCaptureAmount">60.0</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">Edges</th>
                                                      <td id="solution-summary-edges">10</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">Project Length</th>
                                                      <td id="solution-summary-projectLength">30</td>
                                                </tr>
                                                </tbody>
                                          </table>
                                          <table class="table table-sm">
                                                <thead>
                                                      <tr>
                                                            <td></td>
                                                            <td>Total Cost<br/>($m/yr)</td>
                                                            <td>Unit Cost<br/>($/tCO<sub>2</sub>)</td>
                                                      </tr>
                                                </thead>
                                                <tbody>
                                                      <tr>
                                                            <th scope="row">Capture</th>
                                                            <td id="solution-summary-totalCapture">130.0</td>
                                                            <td id="solution-summary-unitCapture">2.17</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">Transport</th>
                                                            <td id="solution-summary-totalTransport">4.62</td>
                                                            <td id="solution-summary-unitTransport">0.08</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">Storage</th>
                                                            <td id="solution-summary-totalStorage">-16.06</td>
                                                            <td id="solution-summary-unitStorage">-0.27</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">Total</th>
                                                            <td id="solution-summary-totalCost">118.56</td>
                                                            <td id="solution-summary-unitCost">1.98</td>
                                                      </tr>
                                                </tbody>
                                          </table>
                                    </div>
                                    <div id="experiments_div" style="display:none">
                                                <input type="checkbox" id="checkbox_experiment_01" name="experiment_01" value="Cplex_on_Jun_3,_2019_4:34_PM_fe944263-db65-4a3c-a9c4-30f28967c3f1" autocomplete="off" />
                                                <span class="default-font"><strong>Cplex_on_Jun_3,_2019_4:34_PM_exp</strong></span>
                                    </div>
            
                        <br>
                        </div>
                  </div>
               </div>
               </div>

            <!-- div case_studies  -->

            <div id="case_studies_div" style="display: none;">
            <div class="card border-info">
                        <div class="card-header bg-info text-light" id="case_studies_title"></div>
                        <div class="card-body" id="case_studies_display_body" style="display: none" >
                              <div id="case_stuides_display_summary" >
                              <p>Summary: <strong>Southern Company</strong><br>
                                    <ul>
                                    <li>Ten year business plan and CO2 emissions strategy.</li>
                                    <li>20 coal-fired plants, 156 MtCO2/yr emissions.</li>
                                    <li>65 individual boilers→ boiler level accuracy.</li>
                                    <li>CAPTURE COSTS: $46-102/tCO2 (plant) & $41-166/tCO2 (boiler).</li>
                                    <li>STORAGE: 3.4 GtCO2 in 7 sinks, 113 MtCO2/yr over 30 years.</li>
                                    <li>STORAGE COSTS: $3.78-8.60/tCO2.</li>
                                    </ul>
                              </p>
                              </div>
                              <div id="case_studies_legend">
                              <!--
                              <center><img src="/static/images/southernUS_legend.png"  height="80%" width="80%" alt="southeastUS_legend" /> </center>
                              -->
                              </div>
                              <div id="case_loginuser" style="display: none;">
                                    <button type="button" id="bn_editcase" class="btn btn-primary btn-sm btn-block" onclick="user_edit_case('Southeast_US')">Edit this scenario</button>
                              </div>
                              <div id="case_nologinuser_msg" style="display: none;">Gateway user account required. <a href='/auth/login?next=/maptool/test/'>Login</a>&nbsp;to edit SimCCS model scenarios.</div>
                        </div>
                        <div class="card-body" id="case_studies_editor_Southeast_US" style="display: none" >
                              Use mouse-click to select source and sink data.<br><br>
                              <button type="button" class="btn btn-primary btn-sm btn-block" onclick="case_hideunselected()" id="case_hideunselected_btn" value="hide">Hide unselected data</button>
                              <button type="button" class="btn btn-primary btn-sm btn-block" onclick="case_generateinputfile()">Generate Data Files</button>
                              <div id="case_downloadsource_div" style="display: none;"><a href="" id="case_sources_input">Download Source.txt</a></div>
                              <div id="case_downloadsink_div" style="display: none;"><a href="" id="case_sinks_input">Download Sinks.txt</a></div>
                              <br>  
                              <strong>Model Parameters</strong><br>
                              <table>
                                          <tr><td>Capital Recovery Rate</td><td><input id="case_Capital_Recovery_Rate" name="case_Capital_Recovery_Rate" type="text" size=8 value=0.1 required></td></tr>
                                          <tr><td>Project Period (yrs)</td><td><input id="case_Project_Period" name="case_Project_Period" type="text" size=8 value=10 required></td></tr>
                                          <tr><td>Capture Target (MT/y)</td><td><input id="case_Capture_Target" name="caase_Capture_Target" type="text" size=8 value=5 required></td></tr>
                              </table><br>
                              <button type="button" id="bn_generatemps" class="btn btn-primary btn-sm btn-block" onclick="case_generatempsfile()">Generate MPS file</button>
      
                        </div>

            </div></div>
            <!-- end of case stuides -->
      </div>
               <div class="col-md-9">
                  <div id="map"></div>
               </div>
            </div>
         </div>
      </div>

      </div> <!-- container-fluid -->
    </main>
  </div>


{% endblock content %}
